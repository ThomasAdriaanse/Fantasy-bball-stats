<!DOCTYPE html>
<html>
<head>
    <title>Basketball Data - Categories Comparison</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/compare_page.css') }}">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Grid layout for 3x3 graphs */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 20px;
            padding: 20px;
        }

        .graph-wrapper {
            border: 1px solid #ccc;
            padding: 10px;
        }

        .graph-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* Ensure SVG fills the container */
        .chart-svg {
            width: 100%;
            height: 300px;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 800px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EZ4LV1SKJ1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EZ4LV1SKJ1');
</script>

<body>
    <button id="back-button" onclick="window.history.back()">Back</button>
    <div class="team-names">
        <div class="team-name-left">
            <span>{{ data_team_stats_1[0]['team_name'] }}</span>
            <span>&nbsp;&nbsp;&nbsp;{{ data_team_stats_1[0]['team_current_points'] }}</span>
        </div>
        <div class="team-name-right">
            <span>{{ data_team_stats_2[0]['team_current_points'] }}&nbsp;&nbsp;&nbsp;</span>
            <span>{{ data_team_stats_2[0]['team_name'] }}</span>
        </div>
    </div>         
    <div class="table-container">
        <!-- Player and Team Stats Tables (Same as in points.html) -->
        <!-- First Team Tables -->
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Player Name</th>
                        <th>MIN</th>
                        <th>FGM</th>
                        <th>FGA</th>
                        <th>FTM</th>
                        <th>FTA</th>
                        <th>3PTM</th>
                        <th>REB</th>
                        <th>AST</th>
                        <th>STL</th>
                        <th>BLK</th>
                        <th>TO</th>
                        <th>PTS</th>
                        <th>FPTS</th>
                        <th>Games Left</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in data_team_players_1 %}
                    <tr>
                        <td class="{{ 'player-out' if row['inj'] == 'OUT' else 'player-dtd' if row['inj'] == 'DAY_TO_DAY' else '' }}">
                            {{ row['player_name'] }}
                        </td>
                        <td>{{ row['min'] }}</td>
                        <td>{{ row['fgm'] }}</td>
                        <td>{{ row['fga'] }}</td>
                        <td>{{ row['ftm'] }}</td>
                        <td>{{ row['fta'] }}</td>
                        <td>{{ row['threeptm'] }}</td>
                        <td>{{ row['reb'] }}</td>
                        <td>{{ row['ast'] }}</td>
                        <td>{{ row['stl'] }}</td>
                        <td>{{ row['blk'] }}</td>
                        <td>{{ row['turno'] }}</td>
                        <td>{{ row['pts'] }}</td>
                        <td>{{ row['fpts'] }}</td>
                        <td>{{ row['games'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <!-- Team Win Percentage Stats Table -->
            <table class="data-table">
                <thead>
                    <tr>
                        {% for key in team1_win_pct_data[0].keys() %}
                            <th>{{ key }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {% for key, value in team1_win_pct_data[0].items() %}
                            <td>{{ value }}</td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Second Team Tables -->
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Player Name</th>
                        <th>MIN</th>
                        <th>FGM</th>
                        <th>FGA</th>
                        <th>FTM</th>
                        <th>FTA</th>
                        <th>3PTM</th>
                        <th>REB</th>
                        <th>AST</th>
                        <th>STL</th>
                        <th>BLK</th>
                        <th>TO</th>
                        <th>PTS</th>
                        <th>FPTS</th>
                        <th>Games Left</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in data_team_players_2 %}
                    <tr>
                        <td class="{{ 'player-out' if row['inj'] == 'OUT' else 'player-dtd' if row['inj'] == 'DAY_TO_DAY' else '' }}">
                            {{ row['player_name'] }}
                        </td>
                        <td>{{ row['min'] }}</td>
                        <td>{{ row['fgm'] }}</td>
                        <td>{{ row['fga'] }}</td>
                        <td>{{ row['ftm'] }}</td>
                        <td>{{ row['fta'] }}</td>
                        <td>{{ row['threeptm'] }}</td>
                        <td>{{ row['reb'] }}</td>
                        <td>{{ row['ast'] }}</td>
                        <td>{{ row['stl'] }}</td>
                        <td>{{ row['blk'] }}</td>
                        <td>{{ row['turno'] }}</td>
                        <td>{{ row['pts'] }}</td>
                        <td>{{ row['fpts'] }}</td>
                        <td>{{ row['games'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <!-- Team Win Percentage Stats Table -->
            <table class="data-table">
                <thead>
                    <tr>
                        {% for key in team2_win_pct_data[0].keys() %}
                            <th>{{ key }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {% for key, value in team2_win_pct_data[0].items() %}
                            <td>{{ value }}</td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="graph-container">
        <p>Graphs update at end of day (PST)</p>  
        <h2>Team Comparison - Projected Categories</h2>
        <div class="grid-container">
            {% for cat in combined_jsons.keys() %}
            <div class="graph-wrapper">
                <div class="graph-title">{{ cat }}</div>
                <div id="chart-{{ loop.index }}" class="chart-svg"></div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        // Tracking time for graph to load
        const graphRenderStart = performance.now();
    
        // Parse combinedJsons from Flask
        const combinedJsons = {{ combined_jsons | tojson }};
        const categories = Object.keys(combinedJsons);
    
        // Team names
        const team1Name = "{{ data_team_stats_1[0]['team_name'] }}";
        const team2Name = "{{ data_team_stats_2[0]['team_name'] }}";
    
        categories.forEach((cat, index) => {
            // Parse JSON data for the current category
            const graphData = combinedJsons[cat].map(d => ({
                date: new Date(d.date), // Ensure date parsing matches the old page
                predicted_cat: +d.predicted_cat,
                predicted_cat_from_present: +d.predicted_cat_from_present,
                team: d.team,
                category: d.category
            }));
    
            // Normalize all dates to midnight to match the old graph logic
            graphData.forEach(d => {
                d.date.setDate(d.date.getDate()+1);
                d.date.setHours(0, 0, 0, 0);
            });
    
            // Get today's date to differentiate between past and future
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to midnight for accurate comparison
    
            // Split data into Team 1 and Team 2 based on the team field
            const team1Data = graphData.filter(d => d.team === "Team 1");
            const team2Data = graphData.filter(d => d.team === "Team 2");
    
            // Split Team 1 data into past and future segments based on today
            const team1PastData = team1Data.filter(d => d.date <= today);
            const team1FutureData = team1Data.filter(d => d.date >= today);
    
            // Split Team 2 data into past and future segments based on today
            const team2PastData = team2Data.filter(d => d.date <= today);
            const team2FutureData = team2Data.filter(d => d.date >= today);
    
            // Set the dimensions and margins for the graph
            const margin = { top: 20, right: 30, bottom: 30, left: 40 },
                width = 300 - margin.left - margin.right,
                height = 200 - margin.top - margin.bottom;
    
            // Append the svg object to the corresponding chart div
            const svg = d3.select("#chart-" + (index + 1))
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
            // Add X axis
            const x = d3.scaleTime()
                .domain(d3.extent(graphData, d => d.date))
                .range([0, width]);
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x)
                    .ticks(d3.timeDay.every(1)) // One tick per day
                    .tickFormat(d3.timeFormat("%b %d")) // Format ticks as "Month Day"
                )
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");
    
            // Add Y axis
            const y = d3.scaleLinear()
                .domain([0, d3.max(graphData, d => Math.max(d.predicted_cat, d.predicted_cat_from_present))])
                .nice()
                .range([height, 0]);
            svg.append("g")
                .call(d3.axisLeft(y));
    
            // Define line generators
            const lineActual = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.predicted_cat_from_present));
    
            // Add the actual line for Team 1 (blue, solid for past)
            svg.append("path")
                .datum(team1PastData)
                .attr("fill", "none")
                .attr("stroke", "blue")
                .attr("stroke-width", 1.5)
                .attr("d", lineActual);
    
            // Add the predicted part of the actual line for Team 1 (dotted for future)
            svg.append("path")
                .datum(team1FutureData)
                .attr("fill", "none")
                .attr("stroke", "blue")
                .attr("stroke-width", 1.5)
                .style("stroke-dasharray", ("5, 5"))
                .attr("d", lineActual);
    
            // Add the actual line for Team 2 (red, solid for past)
            svg.append("path")
                .datum(team2PastData)
                .attr("fill", "none")
                .attr("stroke", "red")
                .attr("stroke-width", 1.5)
                .attr("d", lineActual);
    
            // Add the predicted part of the actual line for Team 2 (dotted for future)
            svg.append("path")
                .datum(team2FutureData)
                .attr("fill", "none")
                .attr("stroke", "red")
                .attr("stroke-width", 1.5)
                .style("stroke-dasharray", ("5, 5"))
                .attr("d", lineActual);
    
            // Add Legend
            const legend = svg.append("g")
                .attr("transform", "translate(0, -10)");
    
            legend.append("line")
                .attr("x1", 0)
                .attr("y1", 10)
                .attr("x2", 20)
                .attr("y2", 10)
                .attr("stroke", "blue")
                .attr("stroke-width", 1.5);
            legend.append("text")
                .attr("x", 25)
                .attr("y", 10)
                .text(`${team1Name} (Actual)`)
                .attr("alignment-baseline", "middle")
                .attr("font-size", "10px");
    
            legend.append("line")
                .attr("x1", 0)
                .attr("y1", 25)
                .attr("x2", 20)
                .attr("y2", 25)
                .attr("stroke", "blue")
                .attr("stroke-width", 1.5)
                .style("stroke-dasharray", ("5, 5"));
            legend.append("text")
                .attr("x", 25)
                .attr("y", 25)
                .text(`${team1Name} (Predicted)`)
                .attr("alignment-baseline", "middle")
                .attr("font-size", "10px");
    
            legend.append("line")
                .attr("x1", 0)
                .attr("y1", 40)
                .attr("x2", 20)
                .attr("y2", 40)
                .attr("stroke", "red")
                .attr("stroke-width", 1.5);
            legend.append("text")
                .attr("x", 25)
                .attr("y", 40)
                .text(`${team2Name} (Actual)`)
                .attr("alignment-baseline", "middle")
                .attr("font-size", "10px");
    
            legend.append("line")
                .attr("x1", 0)
                .attr("y1", 55)
                .attr("x2", 20)
                .attr("y2", 55)
                .attr("stroke", "red")
                .attr("stroke-width", 1.5)
                .style("stroke-dasharray", ("5, 5"));
            legend.append("text")
                .attr("x", 25)
                .attr("y", 55)
                .text(`${team2Name} (Predicted)`)
                .attr("alignment-baseline", "middle")
                .attr("font-size", "10px");
        });
    
        const graphRenderEnd = performance.now();
        console.log(`Graphs render time: ${(graphRenderEnd - graphRenderStart).toFixed(2)} ms`);
    </script>
    

</body>
</html>