{% extends "base.html" %}
{% block title %}Compare (Categories) Â· Fantasy BBall{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/compare_page.css') }}">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* keep injury-colored links */
    .player-out a, .player-dtd a { color: inherit; text-decoration: none; }
    .player-out a:hover, .player-dtd a:hover { text-decoration: underline; }

    /* ===== Category snapshot (labels above, pills below) ===== */
    .cat-snapshot.card { padding: 16px 18px; }
    .cat-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:12px 14px;
      align-items:start;
    }
    .cat-col{display:grid;grid-template-rows:auto auto;row-gap:6px;}
    .cat-label{
      text-align:center;
      font-size:16px;
      letter-spacing:.2px;
      opacity:.9;
    }

    /* Split pill (snapshot) */
    .split-pill{
      position:relative;
      display:grid;
      grid-template-columns:1fr 1fr;
      min-height:34px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.10);
      background:#0b0e14;
      overflow:hidden;
      color:#e8eefc;
      background-clip: padding-box;
    }
    .split-pill::after{
      content:"";position:absolute;left:50%;top:0;bottom:0;width:1px;background:rgba(255,255,255,.18);
    }
    .pill-left,.pill-right{
      padding:7px 10px;
      display:flex;align-items:center;
      font-size:13px;line-height:1.1;
      background-clip: padding-box;
    }
    .pill-left { justify-content:flex-end; text-align:right;
      background: rgba(70,130,180,var(--a1,0)); /* Team 1 blue */
    }
    .pill-right{ justify-content:flex-start; text-align:left;
      background: rgba(255,0,0,var(--a2,0));   /* Team 2 red  */
    }

    /* ===== Tables (unchanged) ===== */
    .data-table.table-compact{ table-layout: fixed; width: 100%; }
    .data-table.table-compact th,
    .data-table.table-compact td{
      text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .win-title{
      margin: 10px 0 6px; text-align: center; font-size: 14px; opacity: .9;
    }

    /* ===== Charts ===== */
    .chart-card { padding: 12px 12px 8px 12px; }
    .chart-card .axis text { font-size: 16px; }

    .legend {
      display:flex; flex-wrap:wrap; gap:6px 12px; align-items:center;
      margin:6px 2px 0; opacity:.95; font-size:13px;
    }
    .legend-item { display:inline-flex; align-items:center; gap:6px; white-space:nowrap; }
    .legend .swatch { width:22px; height:2px; border-radius:2px; display:inline-block; }
    .swatch.solid.blue { background: steelblue; }
    .swatch.solid.red  { background: red; }
    .swatch.dashed.blue {
      background: repeating-linear-gradient(to right, steelblue 0 3px, transparent 3px 6px);
    }
    .swatch.dashed.red {
      background: repeating-linear-gradient(to right, red 0 3px, transparent 3px 6px);
    }

    /* ===== NEW: Highlighted odds block (scoreboard style) ===== */
    .odds-card { padding: 16px 18px; }
    .odds-grid{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:10px 16px;
      align-items:center;
    }
    @media (max-width: 720px){
      .odds-grid{ grid-template-columns: 1fr; }
    }
    .odds-cat{
      text-align:right; padding-right:6px; opacity:.95; font-weight:600;
    }
    @media (max-width: 720px){
      .odds-cat{ text-align:left; padding-right:0; }
    }
    .split-bar{
      position:relative; height:24px; border-radius:999px;
      background:#0b0e14; border:1px solid rgba(255,255,255,0.10);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    .split-bar .left-fill{
      position:absolute; left:0; top:0; bottom:0;
      background: rgba(70,130,180,0.85);   /* Team 1 blue */
    }
    .split-bar .right-fill{
      position:absolute; right:0; top:0; bottom:0;
      background: rgba(255,0,0,0.85);      /* Team 2 red */
    }
    .split-bar .mid-divider{
      position:absolute; top:0; bottom:0; width:1px; left:50%;
      background: rgba(255,255,255,0.18);
      pointer-events:none;
    }
    .bar-label{
      position:absolute; top:50%; transform:translateY(-50%);
      font-size:12px; line-height:1; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.35);
    }
    .bar-label.left { left:8px; }
    .bar-label.right{ right:8px; }
  </style>
{% endblock head_extra %}

{% block content %}
  <div class="body-container">
    {% set t1 = data_team_stats_1|default([{'team_name':'Team 1','team_current_points':''}], true) %}
    {% set t2 = data_team_stats_2|default([{'team_name':'Team 2','team_current_points':''}], true) %}

    <!-- Header pills -->
    <div class="card teams-header">
      <div class="team-pill left">
        <div class="team-name left">{{ t1[0]['team_name'] }}</div>
        <div class="team-points">{{ t1[0]['team_current_points'] }}</div>
      </div>
      <div class="team-pill right">
        <div class="team-points">{{ t2[0]['team_current_points'] }}</div>
        <div class="team-name right">{{ t2[0]['team_name'] }}</div>
      </div>
    </div>

    <!-- ===== CURRENT CATEGORY SNAPSHOT ===== -->
    <div class="card cat-snapshot">
      <div class="cat-grid">
        {# ... (unchanged snapshot loop) ... #}
        {% set scale_map = {
          'PTS':100,'REB':30,'AST':20,'STL':15,'BLK':10,'3PM':15,'FG%':0.05,'FT%':0.05,'TO':10
        } %}
        {% for c in ['PTS','REB','AST','STL','BLK','3PM','FG%','FT%','TO'] %}
          {% set s1 = team1_current_stats.get(c) if team1_current_stats else None %}
          {% set s2 = team2_current_stats.get(c) if team2_current_stats else None %}
          {% set v1 = s1['value'] if s1 and 'value' in s1 else None %}
          {% set v2 = s2['value'] if s2 and 'value' in s2 else None %}
          {% if v1 is not none and v2 is not none %}
            {% if c == 'TO' %}
              {% set t1_wins = v1 < v2 %}{% set t2_wins = v2 < v1 %}
            {% else %}
              {% set t1_wins = v1 > v2 %}{% set t2_wins = v2 > v1 %}
            {% endif %}
            {% set is_tie = (v1 == v2) %}
          {% else %}
            {% set t1_wins = false %}{% set t2_wins = false %}{% set is_tie = true %}
          {% endif %}
          {% set scale = scale_map.get(c,10) %}
          {% if v1 is not none and v2 is not none %}
            {% set diff = (v1 - v2) if (v1 - v2) >= 0 else -(v1 - v2) %}
            {% set intensity = [1, [0, diff/scale]|max]|min %}
          {% else %}
            {% set intensity = 0 %}
          {% endif %}
          {% set alpha = 0.25 + 0.55 * intensity %}
          {% if is_tie %}
            {% set a1 = 0 %}{% set a2 = 0 %}
          {% elif t1_wins %}
            {% set a1 = alpha %}{% set a2 = 0 %}
          {% else %}
            {% set a1 = 0 %}{% set a2 = alpha %}
          {% endif %}
          {% if c in ['FG%','FT%'] %}
            {% set disp1 = ('%.1f%%' % (((v1 or 0) * 100))) if v1 is not none else '-' %}
            {% set disp2 = ('%.1f%%' % (((v2 or 0) * 100))) if v2 is not none else '-' %}
          {% else %}
            {% set disp1 = v1 if v1 is not none else '-' %}
            {% set disp2 = v2 if v2 is not none else '-' %}
          {% endif %}
          <div class="cat-col">
            <div class="cat-label">{{ c }}</div>
            <div class="split-pill" style="--a1:{{ '%.3f' % a1 }}; --a2:{{ '%.3f' % a2 }};"
                 title="{{ t1[0]['team_name'] }} / {{ t2[0]['team_name'] }}">
              <div class="pill-left">{{ disp1 }}</div>
              <div class="pill-right">{{ disp2 }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <!-- ===== END SNAPSHOT ===== -->

    <!-- Players + summary tables -->
    <div class="card">
      <div class="table-container">
        <div class="table-wrapper">
          {# Team 1 table (unchanged) #}
          <table class="data-table">
            <thead>
              <tr>
                <th>Player Name</th>
                <th>MIN</th><th>FGM</th><th>FGA</th><th>FTM</th><th>FTA</th>
                <th>3PTM</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th>
                <th>TO</th><th>PTS</th><th>FPTS</th><th>Games Left</th>
              </tr>
            </thead>
            <tbody>
              {% for row in data_team_players_1 %}
              <tr>
                <td class="{{ 'player-out' if row['inj'] == 'OUT' else 'player-dtd' if row['inj'] == 'DAY_TO_DAY' else '' }}">
                  <a href="{{ url_for('players.player_stats') }}?player_name={{ row['player_name'] }}">{{ row['player_name'] }}</a>
                </td>
                <td>{{ row['min'] }}</td>
                <td>{{ row['fgm'] }}</td>
                <td>{{ row['fga'] }}</td>
                <td>{{ row['ftm'] }}</td>
                <td>{{ row['fta'] }}</td>
                <td>{{ row['threeptm'] }}</td>
                <td>{{ row['reb'] }}</td>
                <td>{{ row['ast'] }}</td>
                <td>{{ row['stl'] }}</td>
                <td>{{ row['blk'] }}</td>
                <td>{{ row['turno'] }}</td>
                <td>{{ row['pts'] }}</td>
                <td>{{ row['fpts'] }}</td>
                <td>{{ row['games'] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="table-wrapper">
          {# Team 2 table (unchanged) #}
          <table class="data-table">
            <thead>
              <tr>
                <th>Player Name</th>
                <th>MIN</th><th>FGM</th><th>FGA</th><th>FTM</th><th>FTA</th>
                <th>3PTM</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th>
                <th>TO</th><th>PTS</th><th>FPTS</th><th>Games Left</th>
              </tr>
            </thead>
            <tbody>
              {% for row in data_team_players_2 %}
              <tr>
                <td class="{{ 'player-out' if row['inj'] == 'OUT' else 'player-dtd' if row['inj'] == 'DAY_TO_DAY' else '' }}">
                  <a href="{{ url_for('players.player_stats') }}?player_name={{ row['player_name'] }}">{{ row['player_name'] }}</a>
                </td>
                <td>{{ row['min'] }}</td>
                <td>{{ row['fgm'] }}</td>
                <td>{{ row['fga'] }}</td>
                <td>{{ row['ftm'] }}</td>
                <td>{{ row['fta'] }}</td>
                <td>{{ row['threeptm'] }}</td>
                <td>{{ row['reb'] }}</td>
                <td>{{ row['ast'] }}</td>
                <td>{{ row['stl'] }}</td>
                <td>{{ row['blk'] }}</td>
                <td>{{ row['turno'] }}</td>
                <td>{{ row['pts'] }}</td>
                <td>{{ row['fpts'] }}</td>
                <td>{{ row['games'] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      {# ===== Odds (clean, single full-width bar per row) ===== #}
      <div class="card odds-card-v2" style="margin-top:12px;">
        <h3 class="win-title" style="margin-top:0">Odds of winning each category</h3>

        <div class="odds-list-v2">
          {% set t1_pcts = team1_win_pct_data[0] %}
          {% set display_map = {
            'threeptm':'3PM','3ptm':'3PM','fg3m':'3PM','fg3_pm':'3PM',
            'fg%':'FG%','fg_pct':'FG%','ft%':'FT%','ft_pct':'FT%',
            'turno':'TO','to':'TO'
          } %}

          {% for cat, pct1 in t1_pcts.items() %}
            {% set p1 = (pct1|float) %}
            {% set p1 = 0 if p1 < 0 else (100 if p1 > 100 else p1) %}
            {% set p2 = 100 - p1 %}
            {% set t1_wins = p1 > p2 %}
            {% set tie = p1 == p2 %}

            {# Pretty label: 3PM / FG% / FT% / TO etc. #}
            {% set key_lower = (cat|string)|lower %}
            {% set disp_cat = display_map.get(key_lower, (cat|string)|upper) %}

            <div class="odds-item-v2">
              <div class="odds-label-v2">{{ disp_cat }}</div>

              <div class="odds-bar-v2
                          {% if tie %}is-tie{% elif t1_wins %}winner-left{% else %}winner-right{% endif %}"
                  title="{{ '%.1f' % p1 }}% vs {{ '%.1f' % p2 }}%">
                <div class="odds-left-v2"  style="width: {{ '%.3f' % p1 }}%;"></div>
                <div class="odds-right-v2" style="width: {{ '%.3f' % p2 }}%;"></div>
                <div class="odds-mid-v2"></div>

                <div class="odds-tag-v2 left  {% if t1_wins %}strong{% elif tie %}{% else %}muted{% endif %}">{{ '%.0f' % p1 }}%</div>
                <div class="odds-tag-v2 right {% if not t1_wins and not tie %}strong{% elif tie %}{% else %}muted{% endif %}">{{ '%.0f' % p2 }}%</div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

    </div>

    <!-- ===== Mini charts ===== -->
    <div id="graph-container" class="graph-section card">
      <p>Graphs update at end of day (PST)</p>
      <h2>Team Comparison â Projected Categories</h2>
      <div class="grid-container chart-grid">
        {% for cat in combined_jsons.keys() %}
        <div class="graph-wrapper chart-card">
          <div class="graph-title chart-title">{{ cat }}</div>
          <div id="chart-{{ (cat|replace('%','pct')|replace('3PM','3pm')|lower) }}" class="chart-svg"></div>
          <!-- per-chart legend appended by D3 -->
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock content %}

{% block body_js %}
  <script>
    const combinedJsons = {{ combined_jsons|default({}, true)|tojson }};
    const categories = Object.keys(combinedJsons);
    const slug = c => c.replace('%','pct').replace('3PM','3pm').toLowerCase();

    const team1Name = {{ (data_team_stats_1|default([{'team_name':'Team 1'}], true))[0]['team_name']|tojson }};
    const team2Name = {{ (data_team_stats_2|default([{'team_name':'Team 2'}], true))[0]['team_name']|tojson }};
    const shorten = s => s && s.length > 18 ? (s.slice(0,16) + 'â¦') : (s || '');

    categories.forEach((cat) => {
      const graphData = combinedJsons[cat].map(d => ({
        date: new Date(d.date),
        predicted_cat: +d.predicted_cat,
        predicted_cat_from_present: +d.predicted_cat_from_present,
        team: d.team,
        category: d.category
      }));
      graphData.forEach(d => { d.date.setDate(d.date.getDate()+1); d.date.setHours(0,0,0,0); });

      const today = new Date(); today.setHours(0,0,0,0);

      const team1Data = graphData.filter(d => d.team === "Team 1");
      const team2Data = graphData.filter(d => d.team === "Team 2");
      const team1PastData = team1Data.filter(d => d.date <= today);
      const team1FutureData = team1Data.filter(d => d.date >= today);
      const team2PastData = team2Data.filter(d => d.date <= today);
      const team2FutureData = team2Data.filter(d => d.date >= today);

      const containerSel = d3.select("#chart-" + slug(cat));
      const containerNode = containerSel.node();
      const containerW = (containerNode && containerNode.clientWidth) ? containerNode.clientWidth : 320;

      const rawMax = d3.max(graphData, d => Math.max(d.predicted_cat, d.predicted_cat_from_present));
      const labelText = (cat === 'FG%' || cat === 'FT%') ? d3.format(".2f")(rawMax) : d3.format(",")(rawMax);
      const leftMargin = Math.max(36, labelText.toString().length * 7 + 12);

      const margin = { top: 10, right: 14, bottom: 44, left: leftMargin },
            width  = containerW - margin.left - margin.right,
            height = 210 - margin.top - margin.bottom;

      const svg = containerSel
        .append("svg")
        .attr("width",  containerW)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scaleTime().domain(d3.extent(graphData, d => d.date)).range([0, width]);
      const xAxis = d3.axisBottom(x).ticks(d3.timeDay.every(1)).tickFormat(d3.timeFormat("%b %d"));
      svg.append("g").attr("class","axis axis--x").attr("transform", `translate(0,${height})`)
        .call(xAxis).selectAll("text").attr("transform","rotate(-45)").style("text-anchor","end");

      const isPct = (cat === 'FG%' || cat === 'FT%');
      const yMin = isPct ? Math.max(0, d3.min(graphData, d => Math.min(d.predicted_cat, d.predicted_cat_from_present)) - 0.10) : 0;
      const yMax = isPct ? Math.min(1, d3.max(graphData, d => Math.max(d.predicted_cat, d.predicted_cat_from_present)) + 0.20)
                         : d3.max(graphData, d => Math.max(d.predicted_cat, d.predicted_cat_from_present));
      const y = d3.scaleLinear().domain([yMin, yMax]).nice().range([height, 0]);
      svg.append("g").attr("class","axis axis--y").call(d3.axisLeft(y));

      const lineActual    = d3.line().x(d => x(d.date)).y(d => y(d.predicted_cat_from_present));
      const linePredicted = d3.line().x(d => x(d.date)).y(d => y(d.predicted_cat));

      // Team 1 â actual & predicted
      svg.append("path").datum(team1PastData).attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.8).attr("d", lineActual);
      svg.append("path").datum(team1FutureData).attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.8).style("stroke-dasharray","5,5").attr("d", lineActual);
      svg.append("path").datum(team1Data).attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.4).style("stroke-dasharray","3,3").attr("d", linePredicted);

      // Team 2 â actual & predicted
      svg.append("path").datum(team2PastData).attr("fill","none").attr("stroke","red").attr("stroke-width",1.8).attr("d", lineActual);
      svg.append("path").datum(team2FutureData).attr("fill","none").attr("stroke","red").attr("stroke-width",1.8).style("stroke-dasharray","5,5").attr("d", lineActual);
      svg.append("path").datum(team2Data).attr("fill","none").attr("stroke","red").attr("stroke-width",1.4).style("stroke-dasharray","3,3").attr("d", linePredicted);

      // Legend under each mini-chart
      const t1Short = shorten(team1Name);
      const t2Short = shorten(team2Name);
      const legend = d3.select(containerNode.parentNode).append("div").attr("class", "legend");
      legend.html(`
        <span class="legend-item" title="${team1Name}">
          <span class="swatch solid blue"></span><span>${t1Short} (Actual)</span>
        </span>
        <span class="legend-item" title="${team2Name}">
          <span class="swatch solid red"></span><span>${t2Short} (Actual)</span>
        </span>
        <span class="legend-item" title="${team1Name}">
          <span class="swatch dashed blue"></span><span>${t1Short} (Predicted)</span>
        </span>
        <span class="legend-item" title="${team2Name}">
          <span class="swatch dashed red"></span><span>${t2Short} (Predicted)</span>
        </span>
      `);
    });
  </script>
{% endblock body_js %}
