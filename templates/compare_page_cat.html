<!DOCTYPE html>
<html>
<head>
  <title>Basketball Data - Categories Comparison</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/compare_page.css') }}" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-EZ4LV1SKJ1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); gtag('config', 'G-EZ4LV1SKJ1');
</script>

<body>
  <a id="back-button" href="javascript:history.back()">Back</a>

  <div class="body-container">
    {% set t1 = data_team_stats_1|default([{'team_name':'Team 1','team_current_points':''}], true) %}
    {% set t2 = data_team_stats_2|default([{'team_name':'Team 2','team_current_points':''}], true) %}

    <div class="card teams-header">
      <div class="team-pill left">
        <div class="team-name left">{{ t1[0]['team_name'] }}</div>
        <div class="team-points">{{ t1[0]['team_current_points'] }}</div>
      </div>
      <div class="team-pill right">
        <div class="team-points">{{ t2[0]['team_current_points'] }}</div>
        <div class="team-name right">{{ t2[0]['team_name'] }}</div>
      </div>
    </div>

    <div class="card">
      <div class="table-container">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Player Name</th>
                <th>MIN</th><th>FGM</th><th>FGA</th><th>FTM</th><th>FTA</th>
                <th>3PTM</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th>
                <th>TO</th><th>PTS</th><th>FPTS</th><th>Games Left</th>
              </tr>
            </thead>
            <tbody>
              {% for row in data_team_players_1 %}
              <tr>
                <td class="{{ 'player-out' if row['inj'] == 'OUT' else 'player-dtd' if row['inj'] == 'DAY_TO_DAY' else '' }}">
                  {{ row['player_name'] }}
                </td>
                <td>{{ row['min'] }}</td>
                <td>{{ row['fgm'] }}</td>
                <td>{{ row['fga'] }}</td>
                <td>{{ row['ftm'] }}</td>
                <td>{{ row['fta'] }}</td>
                <td>{{ row['threeptm'] }}</td>
                <td>{{ row['reb'] }}</td>
                <td>{{ row['ast'] }}</td>
                <td>{{ row['stl'] }}</td>
                <td>{{ row['blk'] }}</td>
                <td>{{ row['turno'] }}</td>
                <td>{{ row['pts'] }}</td>
                <td>{{ row['fpts'] }}</td>
                <td>{{ row['games'] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <table class="data-table table-compact" style="margin-top:12px">
            <thead>
              <tr>
                {% for key in team1_win_pct_data[0].keys() %}
                  <th>{{ key }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                {% for key, value in team1_win_pct_data[0].items() %}
                  <td>{{ value }}</td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Player Name</th>
                <th>MIN</th><th>FGM</th><th>FGA</th><th>FTM</th><th>FTA</th>
                <th>3PTM</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th>
                <th>TO</th><th>PTS</th><th>FPTS</th><th>Games Left</th>
              </tr>
            </thead>
            <tbody>
              {% for row in data_team_players_2 %}
              <tr>
                <td class="{{ 'player-out' if row['inj'] == 'OUT' else 'player-dtd' if row['inj'] == 'DAY_TO_DAY' else '' }}">
                  {{ row['player_name'] }}
                </td>
                <td>{{ row['min'] }}</td>
                <td>{{ row['fgm'] }}</td>
                <td>{{ row['fga'] }}</td>
                <td>{{ row['ftm'] }}</td>
                <td>{{ row['fta'] }}</td>
                <td>{{ row['threeptm'] }}</td>
                <td>{{ row['reb'] }}</td>
                <td>{{ row['ast'] }}</td>
                <td>{{ row['stl'] }}</td>
                <td>{{ row['blk'] }}</td>
                <td>{{ row['turno'] }}</td>
                <td>{{ row['pts'] }}</td>
                <td>{{ row['fpts'] }}</td>
                <td>{{ row['games'] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <table class="data-table table-compact" style="margin-top:12px">
            <thead>
              <tr>
                {% for key in team2_win_pct_data[0].keys() %}
                  <th>{{ key }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                {% for key, value in team2_win_pct_data[0].items() %}
                  <td>{{ value }}</td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="graph-container" class="graph-section card">
      <p>Graphs update at end of day (PST)</p>
      <h2>Team Comparison — Projected Categories</h2>
      <div class="grid-container chart-grid">
        {% for cat in combined_jsons.keys() %}
        <div class="graph-wrapper chart-card">
          <div class="graph-title chart-title">{{ cat }}</div>
          <div id="chart-{{ (cat|replace('%','pct')|replace('3PM','3pm')|lower) }}" class="chart-svg"></div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <script>
    const graphRenderStart = performance.now();

    const combinedJsons = {{ combined_jsons|default({}, true)|tojson }};
    const categories = Object.keys(combinedJsons);
    const slug = c => c.replace('%','pct').replace('3PM','3pm').toLowerCase();

    const team1Name = {{ t1[0]['team_name']|tojson }};
    const team2Name = {{ t2[0]['team_name']|tojson }};

    categories.forEach((cat) => {
      const graphData = combinedJsons[cat].map(d => ({
        date: new Date(d.date),
        predicted_cat: +d.predicted_cat,
        predicted_cat_from_present: +d.predicted_cat_from_present,
        team: d.team,
        category: d.category
      }));

      graphData.forEach(d => { d.date.setDate(d.date.getDate()+1); d.date.setHours(0,0,0,0); });

      const today = new Date(); today.setHours(0,0,0,0);

      const team1Data = graphData.filter(d => d.team === "Team 1");
      const team2Data = graphData.filter(d => d.team === "Team 2");
      const team1PastData = team1Data.filter(d => d.date <= today);
      const team1FutureData = team1Data.filter(d => d.date >= today);
      const team2PastData = team2Data.filter(d => d.date <= today);
      const team2FutureData = team2Data.filter(d => d.date >= today);

      const containerNode = d3.select("#chart-" + slug(cat)).node();
      const containerW = (containerNode && containerNode.clientWidth) ? containerNode.clientWidth : 320;

      const rawMax = d3.max(graphData, d => Math.max(d.predicted_cat, d.predicted_cat_from_present));
      const labelText = (cat === 'FG%' || cat === 'FT%') ? d3.format(".2f")(rawMax) : d3.format(",")(rawMax);
      const leftMargin = Math.max(36, labelText.toString().length * 7 + 12);

      const margin = { top: 10, right: 14, bottom: 44, left: leftMargin },
            width  = containerW - margin.left - margin.right,
            height = 210 - margin.top - margin.bottom;

      const svg = d3.select("#chart-" + slug(cat))
        .append("svg")
        .attr("width",  containerW)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scaleTime().domain(d3.extent(graphData, d => d.date)).range([0, width]);
      const xAxis = d3.axisBottom(x).ticks(d3.timeDay.every(1)).tickFormat(d3.timeFormat("%b %d"));
      svg.append("g").attr("class","axis axis--x").attr("transform", `translate(0,${height})`)
        .call(xAxis).selectAll("text").attr("transform","rotate(-45)").style("text-anchor","end");

      const isPct = (cat === 'FG%' || cat === 'FT%');
      const yMin = isPct ? Math.max(0, d3.min(graphData, d => Math.min(d.predicted_cat, d.predicted_cat_from_present)) - 0.10) : 0;
      const yMax = isPct ? Math.min(1, d3.max(graphData, d => Math.max(d.predicted_cat, d.predicted_cat_from_present)) + 0.20)
                         : d3.max(graphData, d => Math.max(d.predicted_cat, d.predicted_cat_from_present));
      const y = d3.scaleLinear().domain([yMin, yMax]).nice().range([height, 0]);
      svg.append("g").attr("class","axis axis--y").call(d3.axisLeft(y));

      const lineActual    = d3.line().x(d => x(d.date)).y(d => y(d.predicted_cat_from_present));
      const linePredicted = d3.line().x(d => x(d.date)).y(d => y(d.predicted_cat));

      svg.append("path").datum(team1PastData).attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.8).attr("d", lineActual);
      svg.append("path").datum(team1FutureData).attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.8).style("stroke-dasharray","5, 5").attr("d", lineActual);
      svg.append("path").datum(team1Data).attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.4).style("stroke-dasharray","3, 3").attr("d", linePredicted);

      svg.append("path").datum(team2PastData).attr("fill","none").attr("stroke","red").attr("stroke-width",1.8).attr("d", lineActual);
      svg.append("path").datum(team2FutureData).attr("fill","none").attr("stroke","red").attr("stroke-width",1.8).style("stroke-dasharray","5, 5").attr("d", lineActual);
      svg.append("path").datum(team2Data).attr("fill","none").attr("stroke","red").attr("stroke-width",1.4).style("stroke-dasharray","3, 3").attr("d", linePredicted);

      /* UNIFIED LEGEND (same as points page) — white text via .chart-legend */
      const legend = svg.append("g").attr("class","chart-legend").attr("transform","translate(0,-6)");
      legend.append("line").attr("x1",0).attr("y1",10).attr("x2",20).attr("y2",10).attr("stroke","steelblue").attr("stroke-width",1.8);
      legend.append("text").attr("x",25).attr("y",10).attr("alignment-baseline","middle").text(`${team1Name} (Actual)`);
      legend.append("line").attr("x1",0).attr("y1",26).attr("x2",20).attr("y2",26).attr("stroke","red").attr("stroke-width",1.8);
      legend.append("text").attr("x",25).attr("y",26).attr("alignment-baseline","middle").text(`${team2Name} (Actual)`);
      const col2x = 180;
      legend.append("line").attr("x1",col2x).attr("y1",10).attr("x2",col2x+20).attr("y2",10).attr("stroke","steelblue").attr("stroke-width",1.4).style("stroke-dasharray","5,5");
      legend.append("text").attr("x",col2x+25).attr("y",10).attr("alignment-baseline","middle").text(`${team1Name} (Pred)`);
      legend.append("line").attr("x1",col2x).attr("y1",26).attr("x2",col2x+20).attr("y2",26).attr("stroke","red").attr("stroke-width",1.4).style("stroke-dasharray","5,5");
      legend.append("text").attr("x",col2x+25).attr("y",26).attr("alignment-baseline","middle").text(`${team2Name} (Pred)`);
    });

    const graphRenderEnd = performance.now();
    console.log(`Graphs render time: ${(graphRenderEnd - graphRenderStart).toFixed(2)} ms`);
  </script>
</body>
</html>
