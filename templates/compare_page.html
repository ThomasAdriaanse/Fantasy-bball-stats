{% extends "base.html" %}
{% block title %}Compare (Points) Â· Fantasy BBall{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/compare_page.css') }}">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* keep injury-colored cells when the name is a link */
    .player-out a, .player-dtd a { color: inherit; text-decoration: none; }
    .player-out a:hover, .player-dtd a:hover { text-decoration: underline; }

      /* tighten vertical spacing just for this page */
    .page-wrap { padding-top: 8px; }         /* was larger globally */
    .body-container { padding: 0 0 24px; }   /* remove the extra top padding */
    .card { margin-top: 8px; }
    .card.teams-header { margin-top: 0; }    /* first card flush to top */

    /* if your base.css has .topnav { margin-bottom: 40px; }, trim it here: */
    .topnav { margin-bottom: 8px; }
  </style>
{% endblock head_extra %}

{% block content %}
  <!-- Team header -->
  <div class="card teams-header">
    <div class="team-pill left">
      <div class="team-name left">{{ data_team_stats_1[0]['team_name'] }}</div>
      <div class="team-points">{{ data_team_stats_1[0]['team_current_points'] }}</div>
    </div>
    <div class="team-pill right">
      <div class="team-points">{{ data_team_stats_2[0]['team_current_points'] }}</div>
      <div class="team-name right">{{ data_team_stats_2[0]['team_name'] }}</div>
    </div>
  </div>

  <div class="card">
    <div class="table-container">
      <!-- Left team tables -->
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Player Name</th>
              <th>MIN</th><th>FGM</th><th>FGA</th><th>FTM</th><th>FTA</th>
              <th>3PTM</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th>
              <th>TO</th><th>PTS</th><th>FPTS</th><th>Games Left</th>
            </tr>
          </thead>
          <tbody>
            {% for row in data_team_players_1 %}
            <tr>
              <td class="{{ 'player-out' if row['inj'] == 'OUT' else 'player-dtd' if row['inj'] == 'DAY_TO_DAY' else '' }}">
                <a href="{{ url_for('player_stats') }}?player_name={{ row['player_name'] }}">{{ row['player_name'] }}</a>
              </td>
              <td>{{ row['min'] }}</td>
              <td>{{ row['fgm'] }}</td>
              <td>{{ row['fga'] }}</td>
              <td>{{ row['ftm'] }}</td>
              <td>{{ row['fta'] }}</td>
              <td>{{ row['threeptm'] }}</td>
              <td>{{ row['reb'] }}</td>
              <td>{{ row['ast'] }}</td>
              <td>{{ row['stl'] }}</td>
              <td>{{ row['blk'] }}</td>
              <td>{{ row['turno'] }}</td>
              <td>{{ row['pts'] }}</td>
              <td>{{ row['fpts'] }}</td>
              <td>{{ row['games'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <table class="data-table table-compact">
          <thead>
            <tr>
              <th>Team Average FPTS</th>
              <th>Expected Total FPTS</th>
              <th>% Chance of winning</th>
            </tr>
          </thead>
          <tbody>
            {% for row in data_team_stats_1 %}
            <tr>
              <td>{{ row['team_avg_fpts'] }}</td>
              <td>{{ row['team_expected_points'] }}</td>
              <td>{{ row['team_chance_of_winning'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Right team tables -->
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Player Name</th>
              <th>MIN</th><th>FGM</th><th>FGA</th><th>FTM</th><th>FTA</th>
              <th>3PTM</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th>
              <th>TO</th><th>PTS</th><th>FPTS</th><th>Games Left</th>
            </tr>
          </thead>
          <tbody>
            {% for row in data_team_players_2 %}
            <tr>
              <td class="{{ 'player-out' if row['inj'] == 'OUT' else 'player-dtd' if row['inj'] == 'DAY_TO_DAY' else '' }}">
                <a href="{{ url_for('player_stats') }}?player_name={{ row['player_name'] }}">{{ row['player_name'] }}</a>
              </td>
              <td>{{ row['min'] }}</td>
              <td>{{ row['fgm'] }}</td>
              <td>{{ row['fga'] }}</td>
              <td>{{ row['ftm'] }}</td>
              <td>{{ row['fta'] }}</td>
              <td>{{ row['threeptm'] }}</td>
              <td>{{ row['reb'] }}</td>
              <td>{{ row['ast'] }}</td>
              <td>{{ row['stl'] }}</td>
              <td>{{ row['blk'] }}</td>
              <td>{{ row['turno'] }}</td>
              <td>{{ row['pts'] }}</td>
              <td>{{ row['fpts'] }}</td>
              <td>{{ row['games'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <table class="data-table table-compact">
          <thead>
            <tr>
              <th>Team Average FPTS</th>
              <th>Expected Total FPTS</th>
              <th>% Chance of winning</th>
            </tr>
          </thead>
          <tbody>
            {% for row in data_team_stats_2 %}
            <tr>
              <td>{{ row['team_avg_fpts'] }}</td>
              <td>{{ row['team_expected_points'] }}</td>
              <td>{{ row['team_chance_of_winning'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div><!-- /table-container -->
  </div><!-- /card -->

  <!-- Graph -->
  <div id="graph-container" class="graph-section card">
    <p>Graph and table update at end of day (PST)</p>
    <h2>Team Comparison - Projected Fantasy Points</h2>
    <div id="graph" class="chart-area">
      <div id="chart"></div>
    </div>
  </div>
{% endblock content %}

{% block body_js %}
  <script>
    const graphRenderStart = performance.now();

    var margin = {top: 30, right: 50, bottom: 30, left: 50},
        width = 800 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    var svg = d3.select("#chart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var graphData = JSON.parse('{{ combined_json | safe }}');
    graphData.forEach(function(d) {
      d.date = new Date(d.date);
      d.date.setDate(d.date.getDate()+1);
      d.date.setHours(0, 0, 0, 0);
      d.predicted_fpts = +d.predicted_fpts;
      d.predicted_fpts_from_present = +d.predicted_fpts_from_present;
    });

    var today = new Date(); today.setHours(0,0,0,0);
    var team1Name = JSON.parse('{{ data_team_stats_1[0]["team_name"] | tojson }}');
    var team2Name = JSON.parse('{{ data_team_stats_2[0]["team_name"] | tojson }}');

    var team1Data = graphData.filter(d => d.team === "Team 1");
    var team2Data = graphData.filter(d => d.team === "Team 2");
    var team1PastData = team1Data.filter(d => d.date <= today);
    var team1FutureData = team1Data.filter(d => d.date >= today);
    var team2PastData = team2Data.filter(d => d.date <= today);
    var team2FutureData = team2Data.filter(d => d.date >= today);

    var x = d3.scaleTime().domain(d3.extent(graphData, d => d.date)).range([0, width]);
    svg.append("g").attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x).ticks(d3.timeDay.every(1)).tickFormat(d3.timeFormat("%b %d")));

    var y = d3.scaleLinear()
      .domain([0, d3.max(graphData, d => Math.max(d.predicted_fpts, d.predicted_fpts_from_present))])
      .nice().range([height, 0]);
    svg.append("g").call(d3.axisLeft(y));

    var lineActual = d3.line().x(d => x(d.date)).y(d => y(d.predicted_fpts_from_present));

    // Team 1 (steelblue)
    svg.append("path").datum(team1PastData)
      .attr("fill","none").attr("stroke","steelblue").attr("stroke-width",2).attr("d", lineActual);
    svg.append("path").datum(team1FutureData)
      .attr("fill","none").attr("stroke","steelblue").attr("stroke-width",2).style("stroke-dasharray","5, 5").attr("d", lineActual);

    // Team 2 (red)
    svg.append("path").datum(team2PastData)
      .attr("fill","none").attr("stroke","red").attr("stroke-width",2).attr("d", lineActual);
    svg.append("path").datum(team2FutureData)
      .attr("fill","none").attr("stroke","red").attr("stroke-width",2).style("stroke-dasharray","5, 5").attr("d", lineActual);

    // Legend
    const legend = svg.append("g").attr("class", "chart-legend").attr("transform", "translate(0,-6)");
    legend.append("line").attr("x1", 0).attr("y1", 10).attr("x2", 20).attr("y2", 10)
      .attr("stroke", "steelblue").attr("stroke-width", 1.8);
    legend.append("text").attr("x", 25).attr("y", 10).attr("alignment-baseline", "middle")
      .text(team1Name + " (Actual)");
    legend.append("line").attr("x1", 0).attr("y1", 26).attr("x2", 20).attr("y2", 26)
      .attr("stroke", "red").attr("stroke-width", 1.8);
    legend.append("text").attr("x", 25).attr("y", 26).attr("alignment-baseline", "middle")
      .text(team2Name + " (Actual)");
    const col2x = 180;
    legend.append("line").attr("x1", col2x).attr("y1", 10).attr("x2", col2x+20).attr("y2", 10)
      .attr("stroke", "steelblue").attr("stroke-width", 1.4).style("stroke-dasharray", "5,5");
    legend.append("text").attr("x", col2x+25).attr("y", 10).attr("alignment-baseline", "middle")
      .text(team1Name + " (Pred)");
    legend.append("line").attr("x1", col2x).attr("y1", 26).attr("x2", col2x+20).attr("y2", 26)
      .attr("stroke", "red").attr("stroke-width", 1.4).style("stroke-dasharray", "5,5");
    legend.append("text").attr("x", col2x+25).attr("y", 26).attr("alignment-baseline", "middle")
      .text(team2Name + " (Pred)");

    const graphRenderEnd = performance.now();
    console.log(`Graph render time: ${(graphRenderEnd - graphRenderStart).toFixed(2)} ms`);
  </script>

  <script>
    const pageLoadStart = performance.now();
    window.addEventListener('load', () => {
      const pageLoadEnd = performance.now();
      console.log(`Total page load time: ${(pageLoadEnd - pageLoadStart).toFixed(2)} ms`);
    });
  </script>
{% endblock body_js %}
