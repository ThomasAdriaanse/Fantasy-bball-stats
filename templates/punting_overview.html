{% extends "base.html" %}
{% block title %}Punting Overview · Fantasy BBall{% endblock %}

{% block content %}
<div class="body-container">
  <div class="page-header">
    <div class="title">Punting Overview — {{ year }}</div>
    <div class="controls">
      <span class="pill">League: {{ league_id }}</span>
      <label for="window">Window:</label>
      <select id="window">
        <option value="projected" {{ 'selected' if stat_window=='projected' else '' }}>projected</option>
        <option value="total"     {{ 'selected' if stat_window=='total'     else '' }}>total</option>
        <option value="last_30"   {{ 'selected' if stat_window=='last_30'   else '' }}>last_30</option>
        <option value="last_15"   {{ 'selected' if stat_window=='last_15'   else '' }}>last_15</option>
        <option value="last_7"    {{ 'selected' if stat_window=='last_7'    else '' }}>last_7</option>
      </select>
    </div>
  </div>

  <div class="legend">
    <span class="swatch blue"></span> Above average (z &gt; 0)
    <span class="swatch mid"></span> Around average (z ≈ 0)
    <span class="swatch red"></span> Below average (z &lt; 0)
    <span class="chip punt">Punt</span> Likely punted category
  </div>
  <div class="hint">
    Bar length shows team <b>strength</b> (0–100%) within the league; color shows <b>relative to average</b> by z-score.
    Percentages are proportions (e.g., 0.476 → 47.6%).
  </div>

  <div id="grid" class="grid"></div>
</div>
{% endblock content %}

{% block head_extra %}
<style>
:root { color-scheme: dark; }
:root{
  --bg:#0b0e14; --card:#10131a; --text:#e8eefc;
  --border:rgba(255,255,255,0.08); --border-strong:rgba(255,255,255,0.18);
  --shadow:0 6px 18px rgba(0,0,0,0.25);
}
.body-container{ max-width:1200px; margin:0 auto; padding:18px 12px 32px; }
.page-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
.title{ font-size:22px; font-weight:700; }
.controls{ display:flex; gap:10px; align-items:center; }
select, .pill{
  background:#0b0e14; color:var(--text); border:1px solid var(--border-strong); border-radius:8px; padding:8px 10px;
}

.grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(260px,1fr));
  gap:16px;
}
@media (max-width:1100px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width:720px){ .grid{ grid-template-columns: 1fr; } }

.card{
  background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px 14px; box-shadow:var(--shadow);
}
.card .team-head{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin-bottom:10px; }
.card .team-name{ font-weight:700; font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.card .punts{ font-size:12px; opacity:.9; display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
.chip{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0b0e14; font-size:12px; }
.chip.punt{ border-color:#ff4a4a; color:#ff9a9a; }

.bar-row{ display:grid; grid-template-columns: 64px 1fr auto; align-items:center; gap:10px; margin:8px 0; }
.cat-label{ font-size:12px; opacity:.9; text-align:right; }
.bar-track{ background:#0b0e14; border:1px solid var(--border); border-radius:999px; height:12px; position:relative; overflow:hidden; }
.bar-fill{ position:absolute; top:0; left:0; bottom:0; border-radius:999px; background:#8fa1b8; } /* color set via JS */
.bar-value{ font-size:12px; opacity:.85; min-width:54px; text-align:right; }

/* Don’t override color; just outline punts */
.bar-row.is-punt .bar-track{ border-color:#ff4a4a; box-shadow:0 0 0 1px rgba(255,74,74,0.35) inset; }

.legend{ display:flex; gap:16px; align-items:center; font-size:12px; opacity:.9; margin: 6px 2px 10px; }
.swatch{ width:24px; height:6px; border-radius:3px; display:inline-block; }
.swatch.blue{ background:rgb(70,130,180); }
.swatch.mid{ background:rgb(160,170,185); }
.swatch.red{ background:rgb(255,72,72); }
.hint{ font-size:12px; opacity:.75; margin: 6px 2px 12px; }
</style>
{% endblock head_extra %}

{% block body_js %}
<script>
  // Data comes from the server
  const DATA = {{ data_json|safe }};
  const categories = DATA.categories;
  const teams = DATA.teams;

  const grid = document.getElementById('grid');

  function fmt(cat, v){
    if (cat === 'FG%' || cat === 'FT%') return (v*100).toFixed(1) + '%';
    return (Math.round(v*100)/100).toString();
  }

  // simple diverging palette from red -> gray -> blue driven by z
  function colorFromZ(z){
    const zClamped = Math.max(-2.0, Math.min(2.0, z));
    const t = (zClamped + 2) / 4; // 0..1
    const red  = [255, 72, 72];
    const gray = [160,170,185];
    const blue = [70,130,180];
    function lerp(a,b,t){ return a + (b-a)*t; }
    function mix(c1,c2,t){ return [lerp(c1[0],c2[0],t), lerp(c1[1],c2[1],t), lerp(c1[2],c2[2],t)]; }
    const mid = 0.5;
    const rgb = (t < mid) ? mix(red, gray, t/mid) : mix(gray, blue, (t-mid)/(1-mid));
    return `rgb(${rgb.map(x=>Math.round(x)).join(',')})`;
  }

  function render(){
    grid.innerHTML = '';
    teams.forEach(team => {
      const card = document.createElement('div');
      card.className = 'card';

      // header
      const head = document.createElement('div');
      head.className = 'team-head';

      const name = document.createElement('div');
      name.className = 'team-name';
      name.textContent = team.team_name;

      const punts = document.createElement('div');
      punts.className = 'punts';
      if (team.punts && team.punts.length){
        team.punts.forEach(c => {
          const chip = document.createElement('span');
          chip.className = 'chip punt';
          chip.textContent = c;
          punts.appendChild(chip);
        });
      } else {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = 'No punts';
        punts.appendChild(chip);
      }

      head.appendChild(name);
      head.appendChild(punts);
      card.appendChild(head);

      // bars per category
      categories.forEach(cat => {
        const row = document.createElement('div');
        row.className = 'bar-row';
        const isPunt = team.punts && team.punts.includes(cat);
        if (isPunt) row.classList.add('is-punt');

        const label = document.createElement('div');
        label.className = 'cat-label';
        label.textContent = cat;

        const track = document.createElement('div');
        track.className = 'bar-track';

        const fill = document.createElement('div');
        fill.className = 'bar-fill';

        // width = strength (0..1), color from z
        const strength = (team.strength && team.strength[cat] != null) ? team.strength[cat] : 0;
        const z = (team.z && team.z[cat] != null) ? team.z[cat] : 0;
        fill.style.width = (strength * 100).toFixed(1) + '%';
        fill.style.background = colorFromZ(z);

        const value = document.createElement('div');
        value.className = 'bar-value';
        const raw = (team.cats && team.cats[cat] != null) ? team.cats[cat] : 0;
        value.textContent = fmt(cat, raw);

        // tooltip with rank + z
        const rank = team.rank && team.rank[cat] != null ? team.rank[cat] : '–';
        row.title = `${cat}: ${fmt(cat, raw)} • Rank ${rank} • z ${z}`;

        track.appendChild(fill);
        row.appendChild(label);
        row.appendChild(track);
        row.appendChild(value);
        card.appendChild(row);
      });

      grid.appendChild(card);
    });
  }

  render();

  // window selector -> reload page to recompute from server
  document.getElementById('window').addEventListener('change', (e) => {
    const w = e.target.value;
    const params = new URLSearchParams(window.location.search);
    params.set('stat_window', w);
    window.location.search = params.toString();
  });
</script>
{% endblock body_js %}
