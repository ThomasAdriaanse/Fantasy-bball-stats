{% extends "base.html" %}
{% block title %}Punting Overview · Fantasy BBall{% endblock %}

{% block content %}
<div class="body-container">
  <div class="page-header">
    <div class="title">Punting Overview</div>
    <div class="controls">
      <span class="pill">League: {{ league_id }}</span>
      <label for="window">Window:</label>
      <select id="window">
        <option value="projected" {{ 'selected' if stat_window=='projected' else '' }}>projected</option>
        <option value="total"     {{ 'selected' if stat_window=='total'     else '' }}>total</option>
        <option value="last_30"   {{ 'selected' if stat_window=='last_30'   else '' }}>last_30</option>
        <option value="last_15"   {{ 'selected' if stat_window=='last_15'   else '' }}>last_15</option>
        <option value="last_7"    {{ 'selected' if stat_window=='last_7'    else '' }}>last_7</option>
      </select>
    </div>
  </div>

  <!-- View toggle -->
  <div class="view-toggle">
    <button id="btnByTeam" class="tab active">By Team</button>
    <button id="btnByCategory" class="tab">By Category</button>
  </div>

  <div class="legend">
    <span class="swatch blue"></span> Above average
    <span class="swatch mid"></span> Average
    <span class="swatch red"></span> Below average
    <span class="chip punt">Punt</span> Likely punted category
  </div>
  <div class="hint">
    Bar length and colour shows category strength per team within the league by team average Z-score; 
  </div>

  <!-- By Team (cards grid) -->
  <div id="viewTeam">
    <div id="grid" class="grid"></div>
  </div>

  <!-- By Category (one table per category) -->
  <div id="viewCategory" class="hidden">
    <div id="catTables"></div>
  </div>
</div>
{% endblock content %}

{% block head_extra %}
<style>
:root { color-scheme: dark; }
:root{
  --bg:#0b0e14; --card:#10131a; --text:#e8eefc;
  --border:rgba(255,255,255,0.08); --border-strong:rgba(255,255,255,0.18);
  --shadow:0 6px 18px rgba(0,0,0,0.25);
}
.body-container{ max-width:1200px; margin:0 auto; padding:18px 12px 32px; }
.page-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
.title{ font-size:22px; font-weight:700; }
.controls{ display:flex; gap:10px; align-items:center; }
select, .pill{
  background:#0b0e14; color:var(--text); border:1px solid var(--border-strong); border-radius:8px; padding:8px 10px;
}

.view-toggle{ display:flex; gap:8px; margin:8px 0 14px; }
.tab{
  background:#0b0e14; color:var(--text); border:1px solid var(--border);
  padding:8px 12px; border-radius:999px; cursor:pointer;
}
.tab.active{ border-color:var(--border-strong); box-shadow:0 0 0 1px var(--border-strong) inset; }

.legend{ display:flex; gap:16px; align-items:center; font-size:12px; opacity:.9; margin: 6px 2px 10px; }
.swatch{ width:24px; height:6px; border-radius:3px; display:inline-block; }
.swatch.blue{ background:rgb(70,130,180); }
.swatch.mid{ background:rgb(160,170,185); }
.swatch.red{ background:rgb(255,72,72); }
.hint{ font-size:12px; opacity:.75; margin: 6px 2px 12px; }

.grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(260px,1fr));
  gap:16px;
}
@media (max-width:1100px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width:720px){ .grid{ grid-template-columns: 1fr; } }

.card{
  background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px 14px; box-shadow:var(--shadow);
}
.card .team-head{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin-bottom:10px; }
.card .team-name{ font-weight:700; font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.card .punts{ font-size:12px; opacity:.9; display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
.chip{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0b0e14; font-size:12px; }
.chip.punt{ border-color:#ff4a4a; color:#ff9a9a; }

.bar-row{ display:grid; grid-template-columns: 64px 1fr auto; align-items:center; gap:10px; margin:8px 0; }
.cat-label{ font-size:12px; opacity:.9; text-align:right; }
.bar-track{ background:#0b0e14; border:1px solid var(--border); border-radius:999px; height:12px; position:relative; overflow:hidden; }
.bar-fill{ position:absolute; top:0; left:0; bottom:0; border-radius:999px; background:#8fa1b8; }
.bar-value{ font-size:12px; opacity:.85; min-width:54px; text-align:right; }
.bar-row.is-punt .bar-track{ border-color:#ff4a4a; box-shadow:0 0 0 1px rgba(255,74,74,0.35) inset; }

.hidden{ display:none; }

/* Category tables */
.cat-section{ margin:18px 0 28px; }
.cat-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.cat-title{ font-weight:700; font-size:18px; }
.cat-table{
  width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow);
}
.cat-table th, .cat-table td{
  padding:10px 12px; border-bottom:1px solid var(--border);
  font-size:14px; color:var(--text);
}
.cat-table th{ text-align:left; opacity:.9; background:#0f1219; }
.cat-table tr:last-child td{ border-bottom:none; }
.cat-miniBar{ height:10px; background:#0b0e14; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
.cat-miniFill{ height:100%; width:0%; background:#8fa1b8; border-radius:999px; }
.badge-punt{ border:1px solid #ff4a4a; color:#ff9a9a; background:#0b0e14; padding:2px 6px; border-radius:999px; font-size:12px; }
.zchip{ font-variant-numeric: tabular-nums; padding:2px 6px; border-radius:6px; background:#0b0e14; border:1px solid var(--border); }
</style>
{% endblock head_extra %}

{% block body_js %}
<script>
  // ---------- Data + helpers ----------
  const DATA = {{ data_json|safe }};
  const categories = DATA.categories;
  const teams = DATA.teams;

  // If server didn’t send rank/strength, compute them here.
  // strength: 0..1 using min-max on "goodness" value per category (invert TO).
  // rank: 1..N, better first (invert TO for comparison too).
  function computeDerived(){
    const N = teams.length;
    teams.forEach(t => { t.rank = t.rank || {}; t.strength = t.strength || {}; });

    categories.forEach(cat => {
      // gather values
      const vals = teams.map(t => t.cats?.[cat] ?? 0);
      // invert for TO “goodness”
      const goodVals = (cat === 'TO') ? vals.map(v => -v) : vals.slice();

      const min = Math.min(...goodVals);
      const max = Math.max(...goodVals);
      const range = (max - min) || 1;

      // compute strength + rank
      const order = goodVals
        .map((v,i) => ({i,v}))
        .sort((a,b) => b.v - a.v)  // better (higher goodness) first
        .map((o,idx) => ({i:o.i, rank:idx+1}));

      order.forEach(o => teams[o.i].rank[cat] = o.rank);
      teams.forEach((t, i) => {
        const s = (goodVals[i] - min) / range;
        t.strength[cat] = s;
      });

      // also ensure z exists
      teams.forEach(t => { if (!t.z) t.z = {}; if (typeof t.z[cat] !== 'number') t.z[cat] = 0; });
    });
  }
  computeDerived();

  function fmt(cat, v){
    if (cat === 'FG%' || cat === 'FT%') return (v*100).toFixed(1) + '%';
    return (Math.round(v*100)/100).toString();
  }

  function colorFromZ(z){
    const zClamped = Math.max(-2.0, Math.min(2.0, z));
    const t = (zClamped + 2) / 4; // 0..1
    const red  = [255, 72, 72];
    const gray = [160,170,185];
    const blue = [70,130,180];
    const mid = 0.5;
    const lerp = (a,b,t) => a + (b-a)*t;
    const mix = (c1,c2,t) => [lerp(c1[0],c2[0],t), lerp(c1[1],c2[1],t), lerp(c1[2],c2[2],t)];
    const rgb = (t < mid) ? mix(red, gray, t/mid) : mix(gray, blue, (t-mid)/(1-mid));
    return `rgb(${rgb.map(x=>Math.round(x)).join(',')})`;
  }

  // ---------- By Team (cards) ----------
  const grid = document.getElementById('grid');

  function renderByTeam(){
    grid.innerHTML = '';
    teams.forEach(team => {
      const card = document.createElement('div');
      card.className = 'card';

      // header
      const head = document.createElement('div');
      head.className = 'team-head';

      const name = document.createElement('div');
      name.className = 'team-name';
      name.textContent = team.team_name;

      const punts = document.createElement('div');
      punts.className = 'punts';
      if (team.punts && team.punts.length){
        team.punts.forEach(c => {
          const chip = document.createElement('span');
          chip.className = 'chip punt';
          chip.textContent = c;
          punts.appendChild(chip);
        });
      } else {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = 'No punts';
        punts.appendChild(chip);
      }

      head.appendChild(name);
      head.appendChild(punts);
      card.appendChild(head);

      // bars per category
      categories.forEach(cat => {
        const row = document.createElement('div');
        row.className = 'bar-row';
        const isPunt = team.punts && team.punts.includes(cat);
        if (isPunt) row.classList.add('is-punt');

        const label = document.createElement('div');
        label.className = 'cat-label';
        label.textContent = cat;

        const track = document.createElement('div');
        track.className = 'bar-track';

        const fill = document.createElement('div');
        fill.className = 'bar-fill';

        // width = strength (0..1), color from z
        const strength = (team.strength && team.strength[cat] != null) ? team.strength[cat] : 0;
        const z = (team.z && team.z[cat] != null) ? team.z[cat] : 0;
        fill.style.width = (strength * 100).toFixed(1) + '%';
        fill.style.background = colorFromZ(z);

        const value = document.createElement('div');
        value.className = 'bar-value';
        const raw = (team.cats && team.cats[cat] != null) ? team.cats[cat] : 0;
        value.textContent = fmt(cat, raw);

        // tooltip with rank + z
        const rank = team.rank && team.rank[cat] != null ? team.rank[cat] : '–';
        row.title = `${cat}: ${fmt(cat, raw)} • Rank ${rank} • z ${z}`;

        track.appendChild(fill);
        row.appendChild(label);
        row.appendChild(track);
        row.appendChild(value);
        card.appendChild(row);
      });

      grid.appendChild(card);
    });
  }

  // ---------- By Category (tables) ----------
  const catRoot = document.getElementById('catTables');

  function renderByCategory(){
    catRoot.innerHTML = '';

    categories.forEach(cat => {
      // sort teams by rank (best first)
      const rows = teams
        .map((t,i) => ({
          team_name: t.team_name,
          value: t.cats?.[cat] ?? 0,
          z: (t.z && typeof t.z[cat] === 'number') ? t.z[cat] : 0,
          rank: (t.rank && t.rank[cat]) || i+1,
          strength: (t.strength && t.strength[cat] != null) ? t.strength[cat] : 0,
          punt: Array.isArray(t.punts) && t.punts.includes(cat)
        }))
        .sort((a,b) => a.rank - b.rank);

      const section = document.createElement('div');
      section.className = 'cat-section';

      const header = document.createElement('div');
      header.className = 'cat-header';

      const title = document.createElement('div');
      title.className = 'cat-title';
      title.textContent = cat;

      const sub = document.createElement('div');
      sub.className = 'hint';

      header.appendChild(title);
      header.appendChild(sub);
      section.appendChild(header);

      const table = document.createElement('table');
      table.className = 'cat-table';

      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th style="width:56px;">Rank</th>
          <th>Team</th>
          <th style="width:160px;">Value</th>
          <th style="width:160px;">z</th>
          <th style="width:200px;">Strength</th>
          <th style="width:80px;">&nbsp;</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      rows.forEach(r => {
        const tr = document.createElement('tr');

        const tdRank = document.createElement('td');
        tdRank.textContent = r.rank;

        const tdTeam = document.createElement('td');
        tdTeam.textContent = r.team_name;

        const tdVal = document.createElement('td');
        tdVal.textContent = fmt(cat, r.value);

        const tdZ = document.createElement('td');
        const zchip = document.createElement('span');
        zchip.className = 'zchip';
        zchip.style.borderColor = 'transparent';
        zchip.style.color = '#fff';
        zchip.style.background = colorFromZ(r.z);
        zchip.textContent = (Math.round(r.z * 100) / 100).toFixed(2);
        tdZ.appendChild(zchip);

        const tdBar = document.createElement('td');
        const bar = document.createElement('div');
        bar.className = 'cat-miniBar';
        const fill = document.createElement('div');
        fill.className = 'cat-miniFill';
        fill.style.width = (r.strength * 100).toFixed(1) + '%';
        fill.style.background = colorFromZ(r.z);
        bar.appendChild(fill);
        tdBar.appendChild(bar);

        const tdPunt = document.createElement('td');
        if (r.punt){
          const badge = document.createElement('span');
          badge.className = 'badge-punt';
          badge.textContent = 'Punt';
          tdPunt.appendChild(badge);
        } else {
          tdPunt.innerHTML = '&nbsp;';
        }

        tr.appendChild(tdRank);
        tr.appendChild(tdTeam);
        tr.appendChild(tdVal);
        tr.appendChild(tdZ);
        tr.appendChild(tdBar);
        tr.appendChild(tdPunt);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      section.appendChild(table);
      catRoot.appendChild(section);
    });
  }

  // initial render
  renderByTeam();

  // ---------- Toggle wiring ----------
  const viewTeam = document.getElementById('viewTeam');
  const viewCategory = document.getElementById('viewCategory');
  const btnByTeam = document.getElementById('btnByTeam');
  const btnByCategory = document.getElementById('btnByCategory');

  function setActive(which){
    if (which === 'team'){
      viewTeam.classList.remove('hidden');
      viewCategory.classList.add('hidden');
      btnByTeam.classList.add('active');
      btnByCategory.classList.remove('active');
      renderByTeam();
    } else {
      viewCategory.classList.remove('hidden');
      viewTeam.classList.add('hidden');
      btnByCategory.classList.add('active');
      btnByTeam.classList.remove('active');
      renderByCategory();
    }
  }
  btnByTeam.addEventListener('click', () => setActive('team'));
  btnByCategory.addEventListener('click', () => setActive('cat'));

  // stat window selector -> reload page (server recompute)
  document.getElementById('window').addEventListener('change', (e) => {
    const w = e.target.value;
    const params = new URLSearchParams(window.location.search);
    params.set('stat_window', w);
    window.location.search = params.toString();
  });
</script>
{% endblock body_js %}
