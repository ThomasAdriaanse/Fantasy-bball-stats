{% extends "base.html" %}
{% block title %}Trade Value{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
<style>
  :root {
    --bg: #0b0e14;
    --card: #10131a;
    --text: #e8eefc;
    --muted: #9fb2cf;
    --border: rgba(255, 255, 255, 0.10);
    --border-2: rgba(255, 255, 255, 0.18);
    --shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
  }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 14px;
  }

  .body-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 14px 12px 32px;
  }

  /* ------- Form layout ------- */
  .trade-form {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .sides-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .side-card {
    border-radius: 12px;
    border: 1px solid var(--border);
    padding: 12px;
  }

  .side-title {
    font-weight: 700;
    opacity: .95;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .select-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-top: 10px;
  }

  .select-row .row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  label {
    font-size: 12px;
    opacity: .8;
    display: block;
    margin-bottom: 4px;
  }

  select {
    width: 100%;
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border-2);
    border-radius: 8px;
    padding: 8px 10px;
  }

  .window-row {
    display: flex;
    gap: 10px;
    align-items: end;
  }

  .window-row .spacer {
    flex: 1;
  }

  .btn {
    background: #0b0e14;
    color: var(--text);
    border: 1px solid var(--border-2);
    border-radius: 8px;
    padding: 9px 14px;
    cursor: pointer;
  }

  .btn:hover {
    filter: brightness(1.06);
  }

  @media (max-width: 820px) {
    .sides-grid {
      grid-template-columns: 1fr;
    }

    .select-row .row-2 {
      grid-template-columns: 1fr;
    }
  }

  /* ------- Summary chips ------- */
  .summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 10px;
  }

  .sum-box {
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .sum-a {
    box-shadow: inset 0 0 0 1px rgba(70, 130, 180, .35);
  }

  .sum-b {
    box-shadow: inset 0 0 0 1px rgba(255, 72, 72, .35);
  }

  .sum-title {
    font-weight: 700;
  }

  .sum-sub {
    font-size: 12px;
    opacity: .85;
  }

  /* ------- Tables ------- */
  table {
    width: 100%;
    border-collapse: collapse;
  }

  th,
  td {
    border-bottom: 1px solid var(--border);
    padding: 8px 10px;
    white-space: nowrap;
    font-size: 14px;
  }

  thead th {
    background: #121722;
    text-align: center;
  }

  td:first-child,
  th:first-child {
    text-align: left;
  }

  /* Player z-color cells */
  .zcell {
    text-align: center;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, .35);
  }

  .player-tables {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  @media (max-width: 980px) {
    .player-tables {
      grid-template-columns: 1fr;
    }
  }

  /* ------- Radar block ------- */
  .viz-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }

  #radar svg {
    width: 100%;
    height: 420px;
    display: block;
  }

  /* ------- Difference bars (A − B) ------- */
  .dz-title {
    font-weight: 700;
    margin-bottom: 4px;
  }

  #dz-chart svg {
    width: 100%;
    height: 360px;
    display: block;
  }

  .dz-axis line,
  .dz-axis path {
    stroke: rgba(255, 255, 255, 0.22);
  }

  .dz-axis text {
    fill: var(--text);
    font-size: 12px;
  }

  .dz-baseline {
    stroke: rgba(255, 255, 255, 0.35);
    stroke-width: 1.2;
  }

  .dz-bar {
    shape-rendering: crispEdges;
  }

  .dz-label {
    fill: var(--text);
    font-size: 11px;
    text-anchor: middle;
  }

  .dz-xlab {
    fill: var(--muted);
    font-size: 11px;
    text-anchor: end;
  }

  .dz-ylab {
    fill: var(--muted);
    text-anchor: middle;
    font-size: 11px;
  }

  /* ------- Overall difference chip ------- */
  .overall-wrap {
    margin-top: 12px;
    display: flex;
    justify-content: center;
  }

  .overall-pill {
    display: inline-flex;
    gap: 10px;
    align-items: center;
    padding: 10px 14px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(255, 255, 255, 0.04);
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
    font-weight: 700;
    color: var(--text);
  }

  .overall-amt {
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.06);
  }

  .amt-pos {
    color: #9fe6a1;
  }

  .amt-neg {
    color: #ff9a9a;
  }

  /* ------- Trade PMF panel ------- */
  .pmf-card {
    margin-top: 12px;
  }

  .pmf-summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 13px;
  }

  .pmf-summary-table th,
  .pmf-summary-table td {
    border-bottom: 1px solid var(--border);
    padding: 6px 8px;
    text-align: center;
    white-space: nowrap;
  }

  .pmf-summary-table th:first-child,
  .pmf-summary-table td:first-child {
    text-align: left;
  }

  .pmf-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
  }

  .pmf-row {
    display: grid;
    grid-template-columns: 70px 1fr 1fr;
    gap: 8px;
    align-items: center;
  }

  .pmf-cat-label {
    font-size: 13px;
    font-weight: 600;
    text-align: left;
    color: var(--muted);
  }

  .pmf-chart-box {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px 6px 6px;
    background: #0b0e14;
  }

  .pmf-chart-title {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 2px;
  }

  .pmf-chart {
    width: 100%;
    height: 120px;
  }

  .pmf-legend {
    margin-top: 6px;
    display: flex;
    gap: 12px;
    font-size: 11px;
    color: var(--muted);
  }

  .pmf-legend-swatch {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 2px;
    margin-right: 4px;
  }
</style>
<script src="https://d3js.org/d3.v7.min.js"></script>
{% endblock head_extra %}

{% block content %}
<div class="body-container">

  <!-- FORM -->
  <form class="card trade-form" method="POST" action="{{ url_for('trades.trade_analyzer') }}">
    <div class="sides-grid">
      <!-- Side A -->
      <div class="side-card">
        <div class="side-title">
          <div>Side A</div>
          <div style="font-size:small;">Players that will be on Team A after the trade</div>
        </div>
        <div class="select-row">
          <div class="row-2">
            <div>
              <label for="a1">Player 1</label>
              <select id="a1" name="a1">
                <option value=""></option>
                {% for n in player_names %}
                <option value="{{ n }}" {% if side_a[0]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="a2">Player 2</label>
              <select id="a2" name="a2">
                <option value=""></option>
                {% for n in player_names %}
                <option value="{{ n }}" {% if side_a[1]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="row-2">
            <div>
              <label for="a3">Player 3</label>
              <select id="a3" name="a3">
                <option value=""></option>
                {% for n in player_names %}
                <option value="{{ n }}" {% if side_a[2]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="a4">Player 4</label>
              <select id="a4" name="a4">
                <option value=""></option>
                {% for n in player_names %}
                <option value="{{ n }}" {% if side_a[3]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Side B -->
      <div class="side-card">
        <div class="side-title">
          <div>Side B</div>
          <div style="font-size:small;">Players that will be on Team B after the trade</div>
        </div>
        <div class="select-row">
          <div class="row-2">
            <div>
              <label for="b1">Player 1</label>
              <select id="b1" name="b1">
                <option value=""></option>
                {% for n in player_names %}
                <option value="{{ n }}" {% if side_b[0]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="b2">Player 2</label>
              <select id="b2" name="b2">
                <option value=""></option>
                {% for n in player_names %}
                <option value="{{ n }}" {% if side_b[1]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="row-2">
            <div>
              <label for="b3">Player 3</label>
              <select id="b3" name="b3">
                <option value=""></option>
                {% for n in player_names %}
                <option value="{{ n }}" {% if side_b[2]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="b4">Player 4</label>
              <select id="b4" name="b4">
                <option value=""></option>
                {% for n in player_names %}
                <option value="{{ n }}" {% if side_b[3]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Trading teams selector -->
    <div class="card" style="margin-top:10px; padding:10px 12px;">
      <div style="font-weight:700; margin-bottom:6px;">Trading teams</div>
      <div class="sides-grid">
        <div>
          <label for="team_a_idx">Team A</label>
          <select id="team_a_idx" name="team_a_idx">
            <option value="">Select Team A</option>
            {% for t in team_options %}
            <option value="{{ t.idx }}" {% if team_a_idx is not none and team_a_idx==t.idx %}selected{% endif %}>
              {{ t.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="team_b_idx">Team B</label>
          <select id="team_b_idx" name="team_b_idx">
            <option value="">Select Team B</option>
            {% for t in team_options %}
            <option value="{{ t.idx }}" {% if team_b_idx is not none and team_b_idx==t.idx %}selected{% endif %}>
              {{ t.name }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <!-- Window / action row -->
    <div class="window-row">
      <div>
        <label for="window">Stats (window)</label>
        <select id="window" name="window">
          {% for w in window_choices %}
          <option value="{{ w }}" {% if stat_window==w %}selected{% endif %}>{{ w }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="spacer"></div>
      <button class="btn" type="submit">Evaluate</button>
    </div>
  </form>

  {% if results %}
  <!-- SUMMARY (Team Z-Score after selection) -->
  <div class="summary-grid">
    <div class="sum-box sum-a">
      <div>
        <div class="sum-title">Side A</div>
        <div class="sum-sub">Team Z-Score</div>
      </div>
      <div style="font-weight:700;">{{ '%.3f' % results.a_totals['_overall'] }}</div>
    </div>
    <div class="sum-box sum-b">
      <div>
        <div class="sum-title">Side B</div>
        <div class="sum-sub">Team Z-Score</div>
      </div>
      <div style="font-weight:700;">{{ '%.3f' % results.b_totals['_overall'] }}</div>
    </div>
  </div>

  <!-- PLAYER TABLES -->
  <div class="card" style="margin-top:12px;">
    <div class="player-tables">
      <div>
        <div style="font-weight:700; margin-bottom:6px;">Side A — Player Z-Scores</div>
        <table>
          <thead>
            <tr>
              <th>Player</th>
              {% for c in categories %}<th>{{ c }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in results.a_players_rows %}
            <tr>
              <td>{{ row.player_name }}</td>
              {% for cell in row.cells %}
              <td class="zcell" style="background: {{ cell.bg }};">{{ '%.2f' % cell.z }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div>
        <div style="font-weight:700; margin-bottom:6px;">Side B — Player Z-Scores</div>
        <table>
          <thead>
            <tr>
              <th>Player</th>
              {% for c in categories %}<th>{{ c }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in results.b_players_rows %}
            <tr>
              <td>{{ row.player_name }}</td>
              {% for cell in row.cells %}
              <td class="zcell" style="background: {{ cell.bg }};">{{ '%.2f' % cell.z }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DIFFERENCE (A − B) by category; Overall shown separately -->
  <div class="card" style="margin-top:12px;">
    <div class="dz-title">Difference in Team Z-Score by Category (Side A − Side B)</div>
    <div id="dz-chart"></div>

    {% set overall_diff = results.a_totals['_overall'] - results.b_totals['_overall'] %}
    <div class="overall-wrap">
      <div class="overall-pill">
        <div>Overall Difference in Team Z-Score (Side A − Side B)</div>
        <div class="overall-amt {{ 'amt-pos' if overall_diff>=0 else 'amt-neg' }}">
          {{ '+' if overall_diff>=0 else '' }}{{ '%.2f' % overall_diff }}
        </div>
      </div>
    </div>
  </div>

  <!-- RADAR -->
  <div class="card viz-grid" style="margin-top:12px;">
    <div id="radar"></div>
  </div>

  <!-- TRADE PMF / WIN% PANEL -->
  <div class="card pmf-card">
    <h3 style="margin-top:0;">Trade impact (PMFs & average win%)</h3>

    <!-- Summary win% table -->
    <div id="trade-pmf-summary"></div>

    <!-- 2-column PMF grid (before / after) -->
    <div class="pmf-grid" id="trade-pmf-grid"></div>

    <!-- Legend -->
    <div class="pmf-legend">
      <div><span class="pmf-legend-swatch" style="background:#4ea4ff;"></span>Trading team (Side A)</div>
      <div><span class="pmf-legend-swatch" style="background:#ff7070;"></span>Trading team (Side B)</div>
      <div><span class="pmf-legend-swatch" style="background:rgba(255,255,255,0.45);"></span>Other teams</div>
    </div>
  </div>

  {% endif %}
</div>
{% endblock content %}

{% block body_js %}
{% if results %}
<script>
  (function () {
    /* ---------- Radar ---------- */
    const cats = {{ categories| tojson
  }};
  const A = {{ results.a_totals| tojson }};
  const B = {{ results.b_totals| tojson }};
  const capRadar = 3;
  const norm = (v) => Math.max(0, Math.min(1, (v + capRadar) / (2 * capRadar)));

  const dataA = cats.map(c => ({ axis: c, val: norm(A[c]) }));
  const dataB = cats.map(c => ({ axis: c, val: norm(B[c]) }));

  const wrapR = d3.select("#radar");
  const wR = wrapR.node().clientWidth || 600, hR = 420, rPad = 50;
  const cx = wR / 2, cy = hR / 2, radius = Math.min(wR, hR) / 2 - rPad;
  const angle = (i) => (i / cats.length) * 2 * Math.PI;
  const r = d3.scaleLinear().domain([0, 1]).range([0, radius]);

  const svgR = wrapR.append("svg").attr("viewBox", `0 0 ${wR} ${hR}`);
  const gR = svgR.append("g").attr("transform", `translate(${cx},${cy})`);

  const rings = [0.25, 0.5, 0.75, 1];
  gR.selectAll(".grid")
    .data(rings).enter().append("circle")
    .attr("r", d => r(d))
    .attr("fill", "none").attr("stroke", "rgba(255,255,255,.18)");

  const axes = gR.selectAll(".axis")
    .data(cats).enter().append("g").attr("class", "axis");

  axes.append("line")
    .attr("x1", 0).attr("y1", 0)
    .attr("x2", (d, i) => Math.cos(angle(i)) * radius)
    .attr("y2", (d, i) => Math.sin(angle(i)) * radius)
    .attr("stroke", "rgba(255,255,255,.22)");

  axes.append("text")
    .attr("x", (d, i) => Math.cos(angle(i)) * (radius + 12))
    .attr("y", (d, i) => Math.sin(angle(i)) * (radius + 12))
    .attr("text-anchor", (d, i) => {
      const a = Math.cos(angle(i));
      return a > 0.15 ? "start" : (a < -0.15 ? "end" : "middle");
    })
    .style("font-size", "12px").style("fill", "#e8eefc")
    .text(d => d);

  function polyPath(data) {
    const points = data.map((d, i) => {
      const a = angle(i), rr = r(d.val);
      return [Math.cos(a) * rr, Math.sin(a) * rr];
    });
    return d3.line().curve(d3.curveCardinalClosed.tension(0.6))(points);
  }

  gR.append("path").attr("d", polyPath(dataA))
    .attr("fill", "rgba(70,130,180,0.25)").attr("stroke", "steelblue").attr("stroke-width", 2);

  gR.append("path").attr("d", polyPath(dataB))
    .attr("fill", "rgba(255,72,72,0.25)").attr("stroke", "red").attr("stroke-width", 2);


  /* ---------- Difference bars: (Side A − Side B) per category ---------- */
  const W = (d3.select("#dz-chart").node().clientWidth || 1000);
  const H = 360;
  const m = { top: 20, right: 20, bottom: 70, left: 68 };
  const innerW = W - m.left - m.right;
  const innerH = H - m.top - m.bottom;

  const dzData = cats.map(c => ({
    cat: c,
    z: (+A[c] || 0) - (+B[c] || 0)
  }));

  const svg = d3.select("#dz-chart").append("svg").attr("viewBox", `0 0 ${W} ${H}`);
  const g = svg.append("g").attr("transform", `translate(${m.left},${m.top})`);

  const cap = 4;
  const zMin = d3.min(dzData, d => d.z);
  const zMax = d3.max(dzData, d => d.z);
  const baseMin = Math.min(-0.5, Math.max(-cap, Math.floor(zMin * 10) / 10));
  const baseMax = Math.max(0.5, Math.min(cap, Math.ceil(zMax * 10) / 10));
  const yPad = Math.max(0.2, (baseMax - baseMin) * 0.06);

  const x = d3.scaleBand()
    .domain(dzData.map(d => d.cat))
    .range([0, innerW])
    .padding(0.20);

  const y = d3.scaleLinear()
    .domain([baseMin - yPad, baseMax + yPad])
    .nice()
    .range([innerH, 0]);

  function zColor(z) {
    if (!isFinite(z)) return "rgba(255,255,255,0.25)";
    const t = Math.max(0, Math.min(1, (z + cap) / (2 * cap)));
    const hue = 120 * t;
    return `hsl(${hue}, 70%, 45%)`;
  }

  g.append("g")
    .attr("class", "dz-axis")
    .attr("transform", `translate(0,${y(0)})`)
    .append("line")
    .attr("class", "dz-baseline")
    .attr("x1", 0).attr("x2", innerW).attr("y1", 0).attr("y2", 0);

  g.append("g").attr("class", "dz-axis").call(d3.axisLeft(y).ticks(6));
  g.append("g")
    .attr("class", "dz-axis")
    .attr("transform", `translate(0,${innerH})`)
    .call(d3.axisBottom(x))
    .selectAll("text")
    .attr("class", "dz-xlab")
    .attr("transform", "rotate(-35)")
    .style("text-anchor", "end");

  g.append("text")
    .attr("class", "dz-ylab")
    .attr("transform", "rotate(-90)")
    .attr("x", -innerH / 2)
    .attr("y", -50)
    .text("Difference in Team Z-Score (Side A − Side B)");

  g.selectAll(".dz-bar")
    .data(dzData)
    .enter()
    .append("rect")
    .attr("class", "dz-bar")
    .attr("x", d => x(d.cat))
    .attr("width", x.bandwidth())
    .attr("y", d => d.z >= 0 ? y(d.z) : y(0))
    .attr("height", d => Math.max(2, Math.abs(y(d.z) - y(0))))
    .attr("fill", d => zColor(d.z));

  g.selectAll(".dz-label")
    .data(dzData)
    .enter()
    .append("text")
    .attr("class", "dz-label")
    .attr("x", d => x(d.cat) + x.bandwidth() / 2)
    .attr("y", d => d.z >= 0 ? (y(d.z) - 10) : (y(d.z) + 16))
    .text(d => isFinite(d.z) ? d.z.toFixed(2) : '—');

  }) ();
</script>

<script>
  (function () {
    const pmfResult = {{ pmf_result| tojson | safe if pmf_result else 'null'
  }};
  if (!pmfResult) {
    console.log("[TRADE-PMF][JS] pmfResult is null");
    return;
  }

  console.log("[TRADE-PMF][JS] pmfResult:", pmfResult);

  const cats = pmfResult.categories || [];
  const teamsMeta = pmfResult.teams || [];
  const before = pmfResult.before || {};
  const after = pmfResult.after || {};
  const trading = pmfResult.trading_teams || {};

  const sideAId = trading.team_a_idx;
  const sideBId = trading.team_b_idx;

  console.log("[TRADE-PMF][JS] trading teams A,B =", sideAId, sideBId);

  const teamById = new Map();
  (teamsMeta || []).forEach(t => {
    // Assume trade_pmf_eval sets team_idx to team_id as requested
    teamById.set(String(t.team_idx), t);
  });

  // ---------- 3.1 Summary win% table ----------
  const winBefore = before.avg_win_pct || {};
  const winAfter = after.avg_win_pct || {};

  function getPct(winDict, teamId, cat) {
    if (teamId === null || teamId === undefined) return null;
    const key = String(teamId);
    const row = winDict[key] || {};
    const v = row[cat];
    return (v == null || isNaN(v)) ? null : Number(v);
  }

  const tA = teamById.get(String(sideAId));
  const tB = teamById.get(String(sideBId));

  if (tA && tB) {
    const tblWrap = d3.select("#trade-pmf-summary");
    tblWrap.html("");

    const table = tblWrap.append("table").attr("class", "pmf-summary-table");
    const thead = table.append("thead").append("tr");
    thead.append("th").text("Category");
    thead.append("th").text(`${tA.team_name} before`);
    thead.append("th").text(`${tA.team_name} after`);
    thead.append("th").text(`${tB.team_name} before`);
    thead.append("th").text(`${tB.team_name} after`);

    const tbody = table.append("tbody");

    cats.forEach(cat => {
      const row = tbody.append("tr");
      row.append("td").text(cat);

      const aBefore = getPct(winBefore, sideAId, cat);
      const aAfter = getPct(winAfter, sideAId, cat);
      const bBefore = getPct(winBefore, sideBId, cat);
      const bAfter = getPct(winAfter, sideBId, cat);

      [aBefore, aAfter, bBefore, bAfter].forEach(val => {
        const cell = row.append("td");
        if (val == null) {
          cell.text("—");
        } else {
          cell.text(val.toFixed(1) + "%");
        }
      });
    });
  } else {
    console.warn("[TRADE-PMF][JS] Could not resolve trading teams in teamById");
  }

  // ---------- 3.2 PMF charts grid (before / after) ----------
  const grid = d3.select("#trade-pmf-grid");
  if (grid.empty()) {
    console.warn("[TRADE-PMF][JS] #trade-pmf-grid missing");
    return;
  }
  grid.html("");

  const beforePmfs = (before.pmfs || {});
  const afterPmfs = (after.pmfs || {});

  const before1d = beforePmfs["1d"] || {};
  const before2d = beforePmfs["2d"] || {};
  const after1d = afterPmfs["1d"] || {};
  const after2d = afterPmfs["2d"] || {};

  function buildRow(cat) {
    const rowDiv = grid.append("div").attr("class", "pmf-row");
    rowDiv.append("div")
      .attr("class", "pmf-cat-label")
      .text(cat);

    const beforeBox = rowDiv.append("div").attr("class", "pmf-chart-box");
    beforeBox.append("div")
      .attr("class", "pmf-chart-title")
      .text("Before trade");
    const beforeChart = beforeBox.append("div")
      .attr("class", "pmf-chart")
      .attr("id", `pmf-before-${cat.replace('%', 'pct')}`);

    const afterBox = rowDiv.append("div").attr("class", "pmf-chart-box");
    afterBox.append("div")
      .attr("class", "pmf-chart-title")
      .text("After trade");
    const afterChart = afterBox.append("div")
      .attr("class", "pmf-chart")
      .attr("id", `pmf-after-${cat.replace('%', 'pct')}`);

    return {
      beforeId: beforeChart.attr("id"),
      afterId: afterChart.attr("id"),
    };
  }

  function teamStroke(teamId) {
    teamId = String(teamId);
    if (String(sideAId) === teamId) return "#4ea4ff";
    if (String(sideBId) === teamId) return "#ff7070";
    return "rgba(255,255,255,0.55)";
  }
  function teamFill(teamId) {
    teamId = String(teamId);
    if (String(sideAId) === teamId) return "rgba(78,164,255,0.25)";
    if (String(sideBId) === teamId) return "rgba(255,112,112,0.25)";
    return "rgba(255,255,255,0.12)";
  }

  function drawPanel(divId, cat, pmfList, isPctCat) {
    const el = document.getElementById(divId);
    if (!el) return;
    if (!Array.isArray(pmfList) || !pmfList.length) {
      console.warn("[TRADE-PMF][JS] No PMF list for", cat, "in", divId);
      return;
    }

    const container = d3.select(el);
    const w = container.node().clientWidth || 420;
    const h = container.node().clientHeight || 120;
    const margin = { top: 10, right: 8, bottom: 20, left: 32 };
    const innerW = w - margin.left - margin.right;
    const innerH = h - margin.top - margin.bottom;

    const allSeries = [];
    pmfList.forEach(entry => {
      const tid = String(entry.team_idx);
      const p = entry.pmf || {};
      if (!p || !Array.isArray(p.probs) || !p.probs.length) return;

      const min = Number(p.min) || 0;
      const series = p.probs.map((prob, i) => {
        const rawX = min + i;
        const xVal = isPctCat ? rawX / 10.0 : rawX;
        return { x: xVal, y: Number(prob), teamId: tid };
      });
      allSeries.push(series);
    });

    if (!allSeries.length) {
      console.warn("[TRADE-PMF][JS] allSeries empty for", cat, "in", divId);
      return;
    }

    const xMin = d3.min(allSeries, s => d3.min(s, d => d.x));
    const xMax = d3.max(allSeries, s => d3.max(s, d => d.x));

    const x = d3.scaleLinear()
      .domain([xMin, xMax])
      .range([0, innerW]);

    const y = d3.scaleLinear()
      .domain([0, 0.10])
      .range([innerH, 0]);

    const svg = container.append("svg")
      .attr("width", w)
      .attr("height", h);

    const g = svg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const xAxis = d3.axisBottom(x)
      .ticks(Math.min(6, Math.max(3, Math.floor(innerW / 60))))
      .tickSizeOuter(0)
      .tickFormat(d => {
        if (!isPctCat) return d3.format("~g")(d);
        return Math.round(d) + "%";
      });

    g.append("g")
      .attr("transform", `translate(0,${innerH})`)
      .call(xAxis)
      .style("color", "#8b949e");

    g.append("g")
      .call(d3.axisLeft(y).ticks(3).tickFormat(d3.format(".0%")))
      .style("color", "#8b949e");

    const area = d3.area()
      .x(d => x(d.x))
      .y0(innerH)
      .y1(d => y(d.y))
      .curve(d3.curveBasis);

    allSeries.forEach(series => {
      const tid = series[0].teamId;
      g.append("path")
        .datum(series)
        .attr("fill", teamFill(tid))
        .attr("stroke", teamStroke(tid))
        .attr(
          "stroke-width",
          (String(sideAId) === tid || String(sideBId) === tid) ? 1.8 : 0.9
        )
        .attr("d", area);
    });
  }

  cats.forEach(cat => {
    const isPctCat = (cat === "FG%" || cat === "FT%");
    const rowIds = buildRow(cat);

    const beforeList = isPctCat
      ? (before2d[cat] || [])
      : (before1d[cat] || []);

    const afterList = isPctCat
      ? (after2d[cat] || [])
      : (after1d[cat] || []);

    drawPanel(rowIds.beforeId, cat, beforeList, isPctCat);
    drawPanel(rowIds.afterId, cat, afterList, isPctCat);
  });

  }) ();
</script>
{% endif %}
{% endblock body_js %}