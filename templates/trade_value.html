{% extends "base.html" %}
{% block title %}Trade Value{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
<style>
  :root{
    --bg:#0b0e14; --card:#10131a; --text:#e8eefc; --muted:#9fb2cf;
    --border:rgba(255,255,255,0.10); --border-2:rgba(255,255,255,0.18);
    --shadow:0 6px 18px rgba(0,0,0,0.25);
  }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:14px; }
  .body-container{ max-width:1200px; margin:0 auto; padding:14px 12px 32px; }

  /* ------- Form layout ------- */
  .trade-form{ display:grid; grid-template-columns: 1fr; gap:12px; }
  .sides-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .side-card{ border-radius:12px; border:1px solid var(--border); padding:12px; }
  .side-title{ font-weight:700; opacity:.95; display:flex; align-items:center; justify-content:space-between; }
  .select-row{ display:grid; grid-template-columns: 1fr; gap:8px; margin-top:10px; }
  .select-row .row-2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  label{ font-size:12px; opacity:.8; display:block; margin-bottom:4px; }
  select{
    width:100%; background:var(--bg); color:var(--text);
    border:1px solid var(--border-2); border-radius:8px; padding:8px 10px;
  }
  .window-row{ display:flex; gap:10px; align-items:end; }
  .window-row .spacer{ flex:1; }
  .btn{ background:#0b0e14; color:var(--text); border:1px solid var(--border-2); border-radius:8px; padding:9px 14px; cursor:pointer; }
  .btn:hover{ filter:brightness(1.06); }

  @media (max-width: 820px){
    .sides-grid{ grid-template-columns: 1fr; }
    .select-row .row-2{ grid-template-columns:1fr; }
  }

  /* ------- Summary chips ------- */
  .summary-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px; }
  .sum-box{ padding:10px 12px; border-radius:10px; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .sum-a{ box-shadow: inset 0 0 0 1px rgba(70,130,180,.35); }
  .sum-b{ box-shadow: inset 0 0 0 1px rgba(255,72,72,.35); }
  .sum-title{ font-weight:700; }
  .sum-sub{ font-size:12px; opacity:.85; }

  /* ------- Tables ------- */
  table{ width:100%; border-collapse:collapse; }
  th, td{ border-bottom:1px solid var(--border); padding:8px 10px; white-space:nowrap; font-size:14px; }
  thead th{ background:#121722; text-align:center; }
  td:first-child, th:first-child{ text-align:left; }

  /* Player z-color cells */
  .zcell{ text-align:center; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35); }
  .player-tables{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width: 980px){ .player-tables{ grid-template-columns:1fr; } }

  /* ------- Radar block ------- */
  .viz-grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
  #radar svg{ width:100%; height:420px; display:block; }

  /* ------- Difference bars (A − B) ------- */
  .dz-title { font-weight:700; margin-bottom:4px; }
  #dz-chart svg{ width:100%; height:360px; display:block; }
  .dz-axis line, .dz-axis path { stroke: rgba(255,255,255,0.22); }
  .dz-axis text { fill: var(--text); font-size: 12px; }
  .dz-baseline { stroke: rgba(255,255,255,0.35); stroke-width: 1.2; }
  .dz-bar { shape-rendering: crispEdges; }
  .dz-label { fill: var(--text); font-size: 11px; text-anchor: middle; }
  .dz-xlab { fill: var(--muted); font-size: 11px; text-anchor: end; }
  .dz-ylab { fill: var(--muted); font-size: 11px; text-anchor: middle; }

  /* ------- Overall difference chip ------- */
  .overall-wrap{ margin-top:12px; display:flex; justify-content:center; }
  .overall-pill{
    display:inline-flex; gap:10px; align-items:center;
    padding:10px 14px; border-radius:999px; border:1px solid var(--border);
    background: rgba(255,255,255,0.04);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
    font-weight:700; color:var(--text);
  }
  .overall-amt{
    font-size:13px; padding:4px 8px; border-radius:8px;
    background: rgba(255,255,255,0.06);
  }
  .amt-pos{ color:#9fe6a1; }
  .amt-neg{ color:#ff9a9a; }
</style>
<script src="https://d3js.org/d3.v7.min.js"></script>
{% endblock head_extra %}

{% block content %}
<div class="body-container">

  <!-- FORM -->
  <form class="card trade-form" method="POST" action="{{ url_for('trades.trade_analyzer') }}">
    <div class="sides-grid">
      <!-- Side A -->
      <div class="side-card">
        <div class="side-title">
          <div>Side A</div>
        </div>
        <div class="select-row">
          <div class="row-2">
            <div>
              <label for="a1">Player 1</label>
              <select id="a1" name="a1">
                <option value=""></option>
                {% for n in player_names %}
                  <option value="{{ n }}" {% if side_a[0]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="a2">Player 2</label>
              <select id="a2" name="a2">
                <option value=""></option>
                {% for n in player_names %}
                  <option value="{{ n }}" {% if side_a[1]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="row-2">
            <div>
              <label for="a3">Player 3</label>
              <select id="a3" name="a3">
                <option value=""></option>
                {% for n in player_names %}
                  <option value="{{ n }}" {% if side_a[2]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="a4">Player 4</label>
              <select id="a4" name="a4">
                <option value=""></option>
                {% for n in player_names %}
                  <option value="{{ n }}" {% if side_a[3]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Side B -->
      <div class="side-card">
        <div class="side-title">
          <div>Side B</div>
        </div>
        <div class="select-row">
          <div class="row-2">
            <div>
              <label for="b1">Player 1</label>
              <select id="b1" name="b1">
                <option value=""></option>
                {% for n in player_names %}
                  <option value="{{ n }}" {% if side_b[0]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="b2">Player 2</label>
              <select id="b2" name="b2">
                <option value=""></option>
                {% for n in player_names %}
                  <option value="{{ n }}" {% if side_b[1]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="row-2">
            <div>
              <label for="b3">Player 3</label>
              <select id="b3" name="b3">
                <option value=""></option>
                {% for n in player_names %}
                  <option value="{{ n }}" {% if side_b[2]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="b4">Player 4</label>
              <select id="b4" name="b4">
                <option value=""></option>
                {% for n in player_names %}
                  <option value="{{ n }}" {% if side_b[3]==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Window / action row -->
    <div class="window-row">
      <div>
        <label for="window">Stats (window)</label>
        <select id="window" name="window">
          {% for w in window_choices %}
            <option value="{{ w }}" {% if stat_window==w %}selected{% endif %}>{{ w }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="spacer"></div>
      <button class="btn" type="submit">Evaluate</button>
    </div>
  </form>

  {% if results %}
  <!-- SUMMARY (Team Z-Score after selection) -->
  <div class="summary-grid">
    <div class="sum-box sum-a">
      <div>
        <div class="sum-title">Side A</div>
        <div class="sum-sub">Team Z-Score</div>
      </div>
      <div style="font-weight:700;">{{ '%.3f' % results.a_totals['_overall'] }}</div>
    </div>
    <div class="sum-box sum-b">
      <div>
        <div class="sum-title">Side B</div>
        <div class="sum-sub">Team Z-Score</div>
      </div>
      <div style="font-weight:700;">{{ '%.3f' % results.b_totals['_overall'] }}</div>
    </div>
  </div>

  <!-- PLAYER TABLES -->
  <div class="card" style="margin-top:12px;">
    <div class="player-tables">
      <div>
        <div style="font-weight:700; margin-bottom:6px;">Side A — Player Z-Scores</div>
        <table>
          <thead>
            <tr>
              <th>Player</th>
              {% for c in categories %}<th>{{ c }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in results.a_players_rows %}
              <tr>
                <td>{{ row.player_name }}</td>
                {% for cell in row.cells %}
                  <td class="zcell" style="background: {{ cell.bg }};">{{ '%.2f' % cell.z }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div>
        <div style="font-weight:700; margin-bottom:6px;">Side B — Player Z-Scores</div>
        <table>
          <thead>
            <tr>
              <th>Player</th>
              {% for c in categories %}<th>{{ c }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in results.b_players_rows %}
              <tr>
                <td>{{ row.player_name }}</td>
                {% for cell in row.cells %}
                  <td class="zcell" style="background: {{ cell.bg }};">{{ '%.2f' % cell.z }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DIFFERENCE (A − B) by category; Overall shown separately -->
  <div class="card" style="margin-top:12px;">
    <div class="dz-title">Difference in Team Z-Score by Category (Side A − Side B)</div>
    <div id="dz-chart"></div>

    <!-- Overall difference (A − B) -->
    {% set overall_diff = results.a_totals['_overall'] - results.b_totals['_overall'] %}
    <div class="overall-wrap">
      <div class="overall-pill">
        <div>Overall Difference in Team Z-Score (Side A − Side B)</div>
        <div class="overall-amt {{ 'amt-pos' if overall_diff>=0 else 'amt-neg' }}">
          {{ '+' if overall_diff>=0 else '' }}{{ '%.2f' % overall_diff }}
        </div>
      </div>
    </div>
  </div>

  <!-- RADAR -->
  <div class="card viz-grid" style="margin-top:12px;">
    <div id="radar"></div>
  </div>
  {% endif %}
</div>
{% endblock content %}

{% block body_js %}
{% if results %}
<script>
(function(){
  /* ---------- Radar (unchanged) ---------- */
  const cats = {{ categories|tojson }};
  const A = {{ results.a_totals|tojson }};
  const B = {{ results.b_totals|tojson }};
  const capRadar = 3;
  const norm = (v)=> Math.max(0, Math.min(1, (v + capRadar) / (2*capRadar)));

  const dataA = cats.map(c => ({axis:c, val:norm(A[c])}));
  const dataB = cats.map(c => ({axis:c, val:norm(B[c])}));

  const wrapR = d3.select("#radar");
  const wR = wrapR.node().clientWidth || 600, hR = 420, rPad = 50;
  const cx = wR/2, cy = hR/2, radius = Math.min(wR,hR)/2 - rPad;
  const angle = (i)=> (i / cats.length) * 2 * Math.PI;
  const r = d3.scaleLinear().domain([0,1]).range([0, radius]);

  const svgR = wrapR.append("svg").attr("viewBox", `0 0 ${wR} ${hR}`);
  const gR = svgR.append("g").attr("transform", `translate(${cx},${cy})`);

  const rings = [0.25, 0.5, 0.75, 1];
  gR.selectAll(".grid")
    .data(rings).enter().append("circle")
    .attr("r", d => r(d))
    .attr("fill","none").attr("stroke","rgba(255,255,255,.18)");

  const axes = gR.selectAll(".axis")
    .data(cats).enter().append("g").attr("class","axis");

  axes.append("line")
    .attr("x1",0).attr("y1",0)
    .attr("x2",(d,i)=> Math.cos(angle(i))*radius)
    .attr("y2",(d,i)=> Math.sin(angle(i))*radius)
    .attr("stroke","rgba(255,255,255,.22)");

  axes.append("text")
    .attr("x",(d,i)=> Math.cos(angle(i))*(radius+12))
    .attr("y",(d,i)=> Math.sin(angle(i))*(radius+12))
    .attr("text-anchor",(d,i)=>{
      const a = Math.cos(angle(i));
      return a>0.15 ? "start" : (a<-0.15 ? "end" : "middle");
    })
    .style("font-size","12px").style("fill","#e8eefc")
    .text(d=>d);

  function polyPath(data){
    const points = data.map((d,i)=>{
      const a = angle(i), rr = r(d.val);
      return [Math.cos(a)*rr, Math.sin(a)*rr];
    });
    return d3.line().curve(d3.curveCardinalClosed.tension(0.6))(points);
  }

  gR.append("path").attr("d", polyPath(dataA))
    .attr("fill","rgba(70,130,180,0.25)").attr("stroke","steelblue").attr("stroke-width",2);

  gR.append("path").attr("d", polyPath(dataB))
    .attr("fill","rgba(255,72,72,0.25)").attr("stroke","red").attr("stroke-width",2);


  /* ---------- Difference bars: (Side A − Side B) per category ---------- */
  const W = (d3.select("#dz-chart").node().clientWidth || 1000);
  const H = 360;
  const m = { top: 20, right: 20, bottom: 70, left: 68 }; // a bit more room
  const innerW = W - m.left - m.right;
  const innerH = H - m.top - m.bottom;

  const dzData = cats.map(c => ({
    cat: c,
    z: (+A[c] || 0) - (+B[c] || 0)   // Side A minus Side B
  }));

  const svg = d3.select("#dz-chart").append("svg").attr("viewBox", `0 0 ${W} ${H}`);
  const g = svg.append("g").attr("transform", `translate(${m.left},${m.top})`);

  // Domain cap (symmetric) + vertical padding so bars don't clip axes
  const cap = 4;
  const zMin = d3.min(dzData, d => d.z);
  const zMax = d3.max(dzData, d => d.z);
  const baseMin = Math.min(-0.5, Math.max(-cap, Math.floor(zMin*10)/10));
  const baseMax = Math.max( 0.5, Math.min( cap, Math.ceil (zMax*10)/10));
  const yPad = Math.max(0.2, (baseMax - baseMin) * 0.06);

  const x = d3.scaleBand()
    .domain(dzData.map(d => d.cat))
    .range([0, innerW])
    .padding(0.20);

  const y = d3.scaleLinear()
    .domain([baseMin - yPad, baseMax + yPad])
    .nice()
    .range([innerH, 0]);

  function zColor(z){
    if (!isFinite(z)) return "rgba(255,255,255,0.25)";
    // 0 -> red (hurts Side A relative), 1 -> green (helps Side A relative)
    const t = Math.max(0, Math.min(1, (z + cap) / (2*cap)));
    const hue = 120 * t; // 0 red .. 120 green
    return `hsl(${hue}, 70%, 45%)`;
  }

  // Baseline at 0
  g.append("g")
    .attr("class","dz-axis")
    .attr("transform", `translate(0,${y(0)})`)
    .append("line")
    .attr("class","dz-baseline")
    .attr("x1", 0).attr("x2", innerW).attr("y1", 0).attr("y2", 0);

  // Axes
  g.append("g").attr("class","dz-axis").call(d3.axisLeft(y).ticks(6));
  g.append("g")
    .attr("class","dz-axis")
    .attr("transform", `translate(0,${innerH})`)
    .call(d3.axisBottom(x))
    .selectAll("text")
    .attr("class","dz-xlab")
    .attr("transform","rotate(-35)")
    .style("text-anchor","end");

  // Y axis label (explicit)
  g.append("text")
    .attr("class","dz-ylab")
    .attr("transform", "rotate(-90)")
    .attr("x", -innerH/2)
    .attr("y", -50)
    .text("Difference in Team Z-Score (Side A − Side B)");

  // Bars
  g.selectAll(".dz-bar")
    .data(dzData)
    .enter()
    .append("rect")
    .attr("class","dz-bar")
    .attr("x", d => x(d.cat))
    .attr("width", x.bandwidth())
    .attr("y", d => d.z >= 0 ? y(d.z) : y(0))
    .attr("height", d => Math.max(2, Math.abs(y(d.z) - y(0))))
    .attr("fill", d => zColor(d.z));

  // Value labels with a bit of clearance
  g.selectAll(".dz-label")
    .data(dzData)
    .enter()
    .append("text")
    .attr("class","dz-label")
    .attr("x", d => x(d.cat) + x.bandwidth()/2)
    .attr("y", d => d.z >= 0 ? (y(d.z) - 10) : (y(d.z) + 16))
    .text(d => isFinite(d.z) ? d.z.toFixed(2) : '—');

})();
</script>
{% endif %}
{% endblock body_js %}
