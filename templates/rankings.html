{% extends "base.html" %}

{% block title %}Player Rankings{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/compare_page.css') }}">
<style>
    /* ===== IMPROVED TABLE STYLING ===== */

    /* Sticky header */
    #rankingsTable thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #121722;
    }

    #rankingsTable thead th {
        background: #121722;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Column widths */
    #rankingsTable th:nth-child(1),
    /* Rank */
    #rankingsTable td:nth-child(1) {
        width: 50px;
        min-width: 50px;
        text-align: center;
        background: rgba(255, 255, 255, 0.02);
        font-weight: 600;
    }

    #rankingsTable th:nth-child(2),
    /* Player */
    #rankingsTable td:nth-child(2) {
        width: 180px;
        min-width: 180px;
        text-align: left;
        position: sticky;
        left: 0;
        background: #10131a;
        z-index: 5;
    }

    #rankingsTable thead th:nth-child(2) {
        z-index: 11;
    }

    #rankingsTable th:nth-child(3),
    /* Team */
    #rankingsTable td:nth-child(3) {
        width: 70px;
        min-width: 70px;
        text-align: center;
    }

    /* Summary columns - visual separation */
    #rankingsTable th:nth-child(5),
    /* Darko Z */
    #rankingsTable th:nth-child(6),
    /* Real Z */
    #rankingsTable th:nth-child(7),
    /* Diff */
    #rankingsTable td:nth-child(5),
    #rankingsTable td:nth-child(6),
    #rankingsTable td:nth-child(7) {
        width: 75px;
        min-width: 75px;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        font-weight: 600;
    }

    /* Stat columns - consistent width */
    #rankingsTable th:nth-child(n+8):nth-child(-n+16),
    #rankingsTable td:nth-child(n+8):nth-child(-n+16) {
        width: 65px;
        min-width: 65px;
        text-align: center;
    }

    /* Total column - strong visual separation */
    #rankingsTable th:nth-child(17),
    /* Total */
    #rankingsTable td:nth-child(17) {
        width: 75px;
        min-width: 75px;
        border-left: 2px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.03);
        font-weight: 700;
        text-align: center;
    }

    /* Text contrast improvements */
    .dynamic-cell,
    .stat-cell {
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Ranking meta columns */
    .ranking-meta {
        text-align: center;
        font-weight: 600;
    }

    /* MPG Column */
    #rankingsTable th:nth-child(4),
    #rankingsTable td:nth-child(4) {
        width: 60px;
        min-width: 60px;
        text-align: center;
        color: #ddd;
    }

    /* Make the table container fill the card */
    .table-container {
        grid-template-columns: 1fr;
        overflow-x: auto;
    }

    .sortable {
        cursor: pointer;
        user-select: none;
        transition: background-color 0.15s;
    }

    .sortable:hover {
        background-color: #1a202c;
    }

    /* Sort indicator */
    .sortable[data-sort-dir="asc"]::after {
        content: " ↑";
        opacity: 0.7;
    }

    .sortable[data-sort-dir="desc"]::after {
        content: " ↓";
        opacity: 0.7;
    }

    /* Toggle buttons styles */
    .view-toggles {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .btn-toggle-view {
        background: #1a202c;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e8eefc;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        opacity: 0.7;
        transition: all 0.2s;
        font-size: 14px;
    }

    .btn-toggle-view:hover {
        opacity: 1;
        background: #2d3748;
    }

    .btn-toggle-view.active {
        opacity: 1;
        background: #3182ce;
        border-color: #63b3ed;
        font-weight: bold;
    }

    /* Page subtitle */
    #pageSubtitle {
        font-size: 18px;
        font-weight: 400;
        opacity: 0.8;
    }

    /* Improve table wrapper */
    .table-wrapper {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="body-container">
    <div class="card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 style="margin:0;">Player Rankings <span id="pageSubtitle">(Projections)</span></h2>
        </div>

        <!-- View Toggles -->
        <div class="view-toggles">
            <button class="btn-toggle-view active" onclick="switchView('darko', this)">Darko (Projections)</button>
            <button class="btn-toggle-view" onclick="switchView('real', this)">Real (2025-26)</button>
            <button class="btn-toggle-view" onclick="switchView('diff', this)">Diff (Darko - Real)</button>
            <button class="btn-toggle-view" onclick="switchView('raw-darko', this)">Raw Darko</button>
            <button class="btn-toggle-view" onclick="switchView('raw-real', this)">Raw Real</button>
        </div>

        <div class="table-container">
            <div class="table-wrapper">
                <table class="data-table table-compact" id="rankingsTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable(0, 'number')">Rank</th>
                            <th class="sortable" onclick="sortTable(1, 'string')">Player</th>
                            <th class="sortable" onclick="sortTable(2, 'string')">Team</th>
                            <th class="sortable" title="Minutes Per Game" onclick="sortTable(3, 'number')">MPG</th>

                            <!-- Summary Columns -->
                            <th class="sortable" title="Total DARKO Z-Score" onclick="sortTable(4, 'number')">Darko Z
                            </th>
                            <th class="sortable" title="Total 2025-26 Season Z-Score" onclick="sortTable(5, 'number')">
                                Real Z</th>
                            <th class="sortable" title="Darko - Real" onclick="sortTable(6, 'number')">Diff</th>

                            <!-- Individual Z Scores (Same order as compare page: FG%, FT%, 3PM, REB, AST, STL, BLK, TO, PTS) -->
                            <th class="sortable dynamic-header" onclick="sortTable(7, 'number')">FG%</th>
                            <th class="sortable dynamic-header" onclick="sortTable(8, 'number')">FT%</th>
                            <th class="sortable dynamic-header" onclick="sortTable(9, 'number')">3PM</th>
                            <th class="sortable dynamic-header" onclick="sortTable(10, 'number')">REB</th>
                            <th class="sortable dynamic-header" onclick="sortTable(11, 'number')">AST</th>
                            <th class="sortable dynamic-header" onclick="sortTable(12, 'number')">STL</th>
                            <th class="sortable dynamic-header" onclick="sortTable(13, 'number')">BLK</th>
                            <th class="sortable dynamic-header" onclick="sortTable(14, 'number')">TO</th>
                            <th class="sortable dynamic-header" onclick="sortTable(15, 'number')">PTS</th>
                            <th class="sortable" onclick="sortTable(16, 'number')">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in players %}
                        <tr>
                            <td>{{ p.rank }}</td>
                            <td data-val="{{ p.player_name }}">
                                <a href="{{ url_for('players.player_stats') }}?player_name={{ p.player_name }}">
                                    {{ p.player_name }}
                                </a>
                            </td>
                            <td>{{ p.team }}</td>
                            <td>{{ "%.1f"|format(p.mpg|float) }}</td>

                            <!-- Totals -->
                            <td class="ranking-meta">
                                {{ "%.2f"|format(p.total_z_darko) }}
                            </td>

                            <td class="ranking-meta" data-val="{{ p.total_z_real if p.has_real_data else -9999 }}">
                                {% if p.has_real_data %}
                                {{ "%.2f"|format(p.total_z_real) }}
                                {% else %}
                                N/A
                                {% endif %}
                            </td>

                            <td class="ranking-meta" data-val="{{ p.diff_z }}">
                                {% if p.has_real_data %}
                                {{ "%+.2f"|format(p.diff_z) }}
                                {% else %}
                                -
                                {% endif %}
                            </td>

                            <!-- Individual Z Scores in compare page order -->
                            {% set zd = p.Z_DARKO %}
                            {% set zr = p.Z_REAL %}
                            {% set zdiff = p.Z_DIFF %}

                            <!-- Raw Data -->
                            {% set rawd = p.RAW_DARKO %}
                            {% set rawr = p.RAW_REAL or {} %}

                            <!-- Order: FG%, FT%, 3PM, REB, AST, STL, BLK, TO, PTS -->
                            <!-- Mapping for RAW keys: 
                                 Z_FG -> FG%
                                 Z_FT -> FT%
                                 Z_FG3M -> FG3M
                                 Z_REB -> REB
                                 Z_AST -> AST
                                 Z_STL -> STL
                                 Z_BLK -> BLK
                                 Z_TOV -> TOV
                                 Z_PTS -> PTS
                            -->
                            {% set cats = [
                            ('FG', 'Z_FG', 'FG%'), ('FT', 'Z_FT', 'FT%'), ('FG3M', 'Z_FG3M', 'FG3M'),
                            ('REB', 'Z_REB', 'REB'), ('AST', 'Z_AST', 'AST'), ('STL', 'Z_STL', 'STL'),
                            ('BLK', 'Z_BLK', 'BLK'), ('TOV', 'Z_TOV', 'TOV'), ('PTS', 'Z_PTS', 'PTS')
                            ] %}

                            {% for short_name, z_key, raw_key in cats %}
                            {% set val_d = zd.get(z_key, 0.0)|float %}
                            {% set val_r = zr.get(z_key, 0.0)|float %}
                            {% set val_diff = zdiff.get(z_key, 0.0)|float %}

                            {% set raw_val_d = rawd.get(raw_key, 0.0)|float %}
                            {% set raw_val_r = rawr.get(raw_key, 0.0)|float %}

                            <td class="dynamic-cell stat-cell" data-darko="{{ val_d }}" data-real="{{ val_r }}"
                                data-diff="{{ val_diff }}" data-raw-darko="{{ raw_val_d }}"
                                data-raw-real="{{ raw_val_r }}" data-val="{{ val_d }}" data-cat="{{ short_name }}">
                                <!-- Add cat for special formatting if needed -->
                                {{ "%.2f"|format(val_d) }}
                            </td>
                            {% endfor %}

                            <!-- Total column -->
                            <td class="stat-total" data-val="{{ p.total_z_darko }}">
                                {{ "%.2f"|format(p.total_z_darko) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Current active mode
    let currentMode = 'darko';

    // Color function matching compare page
    function colorFromZ(z) {
        const zNum = parseFloat(z);
        if (isNaN(zNum)) {
            return 'rgba(128,128,128,0.35)';
        }

        const zmin = -1.6;
        const zmax = 1.7;
        const tRaw = (zNum - zmin) / (zmax - zmin);
        const t = Math.max(0, Math.min(1, tRaw)); // clamp 0..1

        const hue = 120 * t; // 0 = red, 120 = green
        return `hsl(${Math.round(hue)} 70% 35% / 0.90)`;
    }

    function switchView(mode, btn) {
        currentMode = mode;

        // Update Buttons
        document.querySelectorAll('.btn-toggle-view').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Update Subtitle
        const subtitle = document.getElementById('pageSubtitle');
        if (mode === 'darko') subtitle.textContent = "(Projections)";
        if (mode === 'real') subtitle.textContent = "(2025-26 Season)";
        if (mode === 'diff') subtitle.textContent = "(Difference: Darko - Real)";
        if (mode === 'raw-darko') subtitle.textContent = "(Raw Projectons Per Game)";
        if (mode === 'raw-real') subtitle.textContent = "(Raw Season Averages)";

        // Update Table Cells
        const cells = document.querySelectorAll('.dynamic-cell');
        cells.forEach(cell => {
            let val = 0.0;
            let zForColor = 0.0;
            let isRaw = false;

            const cat = cell.getAttribute('data-cat');

            if (mode === 'darko') {
                val = parseFloat(cell.getAttribute('data-darko'));
                zForColor = val;
            } else if (mode === 'real') {
                val = parseFloat(cell.getAttribute('data-real'));
                zForColor = val;
            } else if (mode === 'diff') {
                val = parseFloat(cell.getAttribute('data-diff'));
                zForColor = val;
            } else if (mode === 'raw-darko') {
                val = parseFloat(cell.getAttribute('data-raw-darko'));
                // Use DARKO Z-score for coloring
                zForColor = parseFloat(cell.getAttribute('data-darko'));
                isRaw = true;
            } else if (mode === 'raw-real') {
                val = parseFloat(cell.getAttribute('data-raw-real'));
                // Use REAL Z-score for coloring
                zForColor = parseFloat(cell.getAttribute('data-real'));
                isRaw = true;
            }

            // Validate
            if (isNaN(val)) val = 0.0;

            // Update Text
            if (mode === 'diff') {
                cell.innerText = (val > 0 ? "+" : "") + val.toFixed(2);
            } else {
                // Formatting for raw stats
                if (isRaw && (cat === 'FG' || cat === 'FT')) {
                    cell.innerText = val.toFixed(3);
                } else if (isRaw) {
                    cell.innerText = val.toFixed(1);
                } else {
                    cell.innerText = val.toFixed(2);
                }
            }

            // Apply background color
            cell.style.backgroundColor = colorFromZ(zForColor);

            // Update data-val for sorting
            cell.setAttribute('data-val', val);
        });

        // Update Total column
        updateTotals(mode);
    }

    function updateTotals(mode) {
        const rows = document.querySelectorAll('#rankingsTable tbody tr');
        rows.forEach(row => {
            const totalCell = row.querySelector('.stat-total');
            const statCells = row.querySelectorAll('.dynamic-cell');

            if (mode.startsWith('raw-')) {
                // For raw modes, maybe just show N/A or empty as summing raw stats is weird (FG% + PTS)
                // But user might want sum of counting stats?
                // Let's just blank it out to avoid confusion
                totalCell.textContent = "-";
                totalCell.setAttribute('data-val', -9999);
            } else {
                let sum = 0;
                statCells.forEach(cell => {
                    const val = parseFloat(cell.getAttribute('data-val'));
                    if (!isNaN(val)) sum += val;
                });
                totalCell.textContent = sum.toFixed(2);
                totalCell.setAttribute('data-val', sum);
            }
        });
    }

    function sortTable(n, type) {
        var table = document.getElementById("rankingsTable");
        var rows = Array.from(table.rows).slice(1); // Skip header
        var header = table.rows[0].getElementsByTagName("TH")[n];

        // Determine sort direction
        var currentDir = header.getAttribute("data-sort-dir");
        var dir = (currentDir === "asc") ? "desc" : "asc";

        // Reset other headers
        var allHeaders = table.rows[0].getElementsByTagName("TH");
        for (var i = 0; i < allHeaders.length; i++) {
            allHeaders[i].removeAttribute("data-sort-dir");
        }

        // Set new direction
        header.setAttribute("data-sort-dir", dir);

        rows.sort(function (a, b) {
            var x = a.getElementsByTagName("TD")[n];
            var y = b.getElementsByTagName("TD")[n];

            var xVal = x.getAttribute("data-val") || x.innerText;
            var yVal = y.getAttribute("data-val") || y.innerText;

            if (type === "number") {
                return (parseFloat(xVal) - parseFloat(yVal)) * (dir === "asc" ? 1 : -1);
            } else {
                return xVal.toLowerCase().localeCompare(yVal.toLowerCase()) * (dir === "asc" ? 1 : -1);
            }
        });

        var tbody = table.getElementsByTagName("TBODY")[0];
        rows.forEach(function (row) {
            tbody.appendChild(row);
        });
    }

    // Apply initial colors on page load
    document.addEventListener('DOMContentLoaded', function () {
        const cells = document.querySelectorAll('.dynamic-cell');
        cells.forEach(cell => {
            const zVal = parseFloat(cell.getAttribute('data-darko'));
            cell.style.backgroundColor = colorFromZ(zVal);
        });
    });
</script>
{% endblock %}