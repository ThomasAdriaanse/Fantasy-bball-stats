services:
  web:
    build: .
    ports:
      - "5000:5000"
    env_file: .env
    environment:
      APP_ENV: development
      AWS_SDK_LOAD_CONFIG: "1"
      S3_BUCKET: ${S3_BUCKET}
      S3_PREFIX: ${S3_PREFIX}
      AWS_PROFILE: ${AWS_PROFILE}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
      PLAYER_DATA_CACHE_DIR: /app/data/players
      PLAYER_PMF_CACHE_DIR: /app/data/pmf
    volumes:
      - .:/usr/src/app
      - ./static:/usr/src/app/static
      - "${USERPROFILE}/.aws:/root/.aws:ro"
      - player_data:/app/data/players:ro
      - player_data_pmf:/app/data/pmf:ro

  sync:
    build: ./player-data-sync
    env_file: .env
    environment:
      S3_BUCKET: ${S3_BUCKET}
      S3_PREFIX: ${S3_PREFIX:-dev/players/}
      PLAYER_DATA_CACHE_DIR: /app/data/players
      PLAYER_PMF_CACHE_DIR: /app/data/pmf
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
      SYNC_MODE: ${SYNC_MODE:-sync}
    volumes:
      - "${USERPROFILE}/.aws:/root/.aws:ro"
      - player_data:/app/data/players
      - player_data_pmf:/app/data/pmf
    command: python /app/sync_player_data.py
    profiles:
      - sync

volumes:
  player_data:
  player_data_pmf:
